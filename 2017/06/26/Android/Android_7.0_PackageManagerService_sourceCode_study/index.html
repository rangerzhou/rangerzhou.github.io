<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
<!-- pjax：防止跳转页面音乐暂停 -->
<script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/desert.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/desert.jpg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="OJnYjbr3wdT22qLrZSzyD9lAyBcXiXlEQ7-5wAnaWoQ">
  <meta name="baidu-site-verification" content="vr4n4JeXgB">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"rangerzhou.top","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"manual"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="PKMS模块分三个部分学习：   PKMS的启动、main函数解析 PKMS构造函数解析 APK安装   本文开始分析APK的安装及PKMS在这个流程中所做工作，APK有多种安装方式，我们从adb install开始分析。">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 7.0 PackageManagerService源码分析">
<meta property="og:url" content="http://rangerzhou.top/2017/06/26/Android/Android_7.0_PackageManagerService_sourceCode_study/index.html">
<meta property="og:site_name" content="RangerZhou">
<meta property="og:description" content="PKMS模块分三个部分学习：   PKMS的启动、main函数解析 PKMS构造函数解析 APK安装   本文开始分析APK的安装及PKMS在这个流程中所做工作，APK有多种安装方式，我们从adb install开始分析。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://otqux1hnn.bkt.clouddn.com/rangerzhou/170904/pm.png">
<meta property="og:image" content="http://otqux1hnn.bkt.clouddn.com/rangerzhou/170728/installstage.png">
<meta property="og:image" content="http://otqux1hnn.bkt.clouddn.com/rangerzhou/170728/handleStartCopy.png">
<meta property="og:image" content="http://otqux1hnn.bkt.clouddn.com/rangerzhou/170928/handleReturnCode.png">
<meta property="article:published_time" content="2017-06-26T05:56:01.000Z">
<meta property="article:modified_time" content="2022-07-18T14:46:21.587Z">
<meta property="article:author" content="Ranger Zhou">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://otqux1hnn.bkt.clouddn.com/rangerzhou/170904/pm.png">

<link rel="canonical" href="http://rangerzhou.top/2017/06/26/Android/Android_7.0_PackageManagerService_sourceCode_study/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">

  <title>Android 7.0 PackageManagerService源码分析 | RangerZhou</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-138158952-1"></script>
    <script data-pjax>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-138158952-1');
      }
    </script>


  <script data-pjax>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?24a6d3c4c0f292c5f682d26414c3994b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">

<!-- 加入APlayer音乐播放器 -->
<link rel="stylesheet" href="/dist/APlayer.min.css">
<div id="aplayer"></div>
<script type="text/javascript" src="/dist/APlayer.min.js"></script>
<script type="text/javascript" src="/dist/music.js"></script>

  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">RangerZhou</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Read the fucking source code</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-playlist">

    <a href="/playlist/" rel="section"><i class="fa fa-music fa-fw"></i>歌单</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
        <li class="menu-item menu-item-official">

    <a href="/official" rel="section"><i class="fa fa-user fa-fw"></i>official</a>

  </li>
        <li class="menu-item menu-item-shop">

    <a href="http://rangerzhou.taobao.com/" rel="noopener" target="_blank"><i class="fa fa-user fa-fw"></i>shop</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://rangerzhou.top/2017/06/26/Android/Android_7.0_PackageManagerService_sourceCode_study/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ranger Zhou">
      <meta itemprop="description" content="我是一个小流氓我从来也不浪，有一天我心血来潮耍了个流氓，我嘴里吹着小口哨我心里好得意，不知怎么哗啦啦啦啦我摔了一身泥">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RangerZhou">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android 7.0 PackageManagerService源码分析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-06-26 13:56:01" itemprop="dateCreated datePublished" datetime="2017-06-26T13:56:01+08:00">2017-06-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-18 22:46:21" itemprop="dateModified" datetime="2022-07-18T22:46:21+08:00">2022-07-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          
            <span id="/2017/06/26/Android/Android_7.0_PackageManagerService_sourceCode_study/" class="post-meta-item leancloud_visitors" data-flag-title="Android 7.0 PackageManagerService源码分析" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>PKMS模块分三个部分学习：</p>
</blockquote>
<ul>
<li><a href="">PKMS的启动、main函数解析</a></li>
<li><a href="">PKMS构造函数解析</a></li>
<li><a href="http://rangerzhou.top/2017/06/26/Android%207.0%20PackageManagerService%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">APK安装</a></li>
</ul>
<blockquote>
<p>本文开始分析APK的安装及PKMS在这个流程中所做工作，APK有多种安装方式，我们从adb install开始分析。</p>
</blockquote>
<span id="more"></span>

<h3 id="1-adb-install-分析"><a href="#1-adb-install-分析" class="headerlink" title="1. adb install 分析#"></a>1. adb install 分析#</h3><p>​	adb install 有多个参数，在此仅考虑最简单的<code>adb install ***.apk</code>，adb是命令，install是参数，处理install参数的代码：</p>
<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/system/">system</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/system/core/">core</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/system/core/adb/">adb</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/system/core/adb/commandline.cpp">commandline.cpp</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">... ...</span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> _use_legacy_install() &#123;</span><br><span class="line">    <span class="comment">// 判断Feature是否可用</span></span><br><span class="line">    FeatureSet features;</span><br><span class="line">    std::string error;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">adb_get_feature_set</span>(&amp;features, &amp;error)) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;error: %s\n&quot;</span>, error.<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> !<span class="built_in">CanUseFeature</span>(features, kFeatureCmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">adb_commandline</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  ... ...</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;install&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) <span class="keyword">return</span> <span class="built_in">usage</span>();</span><br><span class="line">        <span class="keyword">if</span> (_use_legacy_install()) &#123;</span><br><span class="line">            <span class="comment">// 如果不能使用Feature，则使用传统方式安装</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">install_app_legacy</span>(transport_type, serial, argc, argv);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 可以使用Feature时，使用如下方式安装</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">install_app</span>(transport_type, serial, argc, argv);</span><br><span class="line">    &#125;</span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-1-install-app"><a href="#1-1-install-app" class="headerlink" title="1.1 install_app"></a>1.1 install_app</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">install_app</span><span class="params">(TransportType transport, <span class="type">const</span> <span class="type">char</span>* serial, <span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// The last argument must be the APK file</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* file = argv[argc - <span class="number">1</span>];<span class="comment">// 利用参数创建出本地文件的名称</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断adb命令中是否存在有效的apk文件名</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* dot = <span class="built_in">strrchr</span>(file, <span class="string">&#x27;.&#x27;</span>);<span class="comment">// 查找&#x27;.&#x27;在file中末次出现的位置，返回从&#x27;.&#x27;开始到结束的字符</span></span><br><span class="line">    <span class="type">bool</span> found_apk = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stat</span> sb;</span><br><span class="line">    <span class="keyword">if</span> (dot &amp;&amp; !<span class="built_in">strcasecmp</span>(dot, <span class="string">&quot;.apk&quot;</span>)) &#123;<span class="comment">// 如果dot不等于null并且等于&quot;.apk&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">stat</span>(file, &amp;sb) == <span class="number">-1</span> || !<span class="built_in">S_ISREG</span>(sb.st_mode)) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Invalid APK file: %s\n&quot;</span>, file);</span><br><span class="line">            <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        found_apk = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!found_apk) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Missing APK file\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// adb_open将根据file创建出对应的文件</span></span><br><span class="line">    <span class="type">int</span> localFd = <span class="built_in">adb_open</span>(file, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (localFd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Failed to open %s: %s\n&quot;</span>, file, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::string error;</span><br><span class="line">    std::string cmd = <span class="string">&quot;exec:cmd package&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加cmd参数</span></span><br><span class="line">    <span class="comment">// don&#x27;t copy the APK name, but, copy the rest of the arguments as-is</span></span><br><span class="line">    <span class="keyword">while</span> (argc-- &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        cmd += <span class="string">&quot; &quot;</span> + <span class="built_in">escape_arg</span>(std::<span class="built_in">string</span>(*argv++));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// add size parameter [required for streaming installs]</span></span><br><span class="line">    <span class="comment">// do last to override any user specified value</span></span><br><span class="line">    cmd += <span class="string">&quot; &quot;</span> + android::base::<span class="built_in">StringPrintf</span>(<span class="string">&quot;-S %&quot;</span> PRIu64, <span class="built_in">static_cast</span>&lt;<span class="type">uint64_t</span>&gt;(sb.st_size));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接源端，获取APK文件的描述符</span></span><br><span class="line">    <span class="type">int</span> remoteFd = <span class="built_in">adb_connect</span>(cmd, &amp;error);</span><br><span class="line">    <span class="keyword">if</span> (remoteFd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Connect error for write: %s\n&quot;</span>, error.<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">adb_close</span>(localFd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buf[BUFSIZ];</span><br><span class="line">    <span class="built_in">copy_to_file</span>(localFd, remoteFd);<span class="comment">// 将remoteFd中的数据写入到上面创建的localFd中</span></span><br><span class="line">    <span class="built_in">read_status_line</span>(remoteFd, buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">adb_close</span>(localFd);</span><br><span class="line">    <span class="built_in">adb_close</span>(remoteFd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strncmp</span>(<span class="string">&quot;Success&quot;</span>, buf, <span class="number">7</span>)) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Failed to install %s: %s&quot;</span>, file, buf);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fputs</span>(buf, stderr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从代码中了解<code>install_app</code>就是将源机器中的文件copy到了目的机器（手机）中，可能是因为这个支持Feature的流程PKMS能够监听到这个copy，接下来继续看传统的安装方式<code>install_app_legacy</code>。</p>
<h4 id="1-2-install-app-legacy"><a href="#1-2-install-app-legacy" class="headerlink" title="1.2 install_app_legacy"></a>1.2 install_app_legacy</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">install_app_legacy</span><span class="params">(TransportType transport, <span class="type">const</span> <span class="type">char</span>* serial, <span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 要安装的APK还在源机器上，要先把APK复制到手机</span></span><br><span class="line">    <span class="comment">// 设置复制目标的目录，如果安装在手机内部存储，则目标目录为/data/local/tmp</span></span><br><span class="line">    <span class="comment">// 如果安装在SD卡上，则目标目录为/sdcard/tmp</span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *<span class="type">const</span> DATA_DEST = <span class="string">&quot;/data/local/tmp/%s&quot;</span>;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *<span class="type">const</span> SD_DEST = <span class="string">&quot;/sdcard/tmp/%s&quot;</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* where = DATA_DEST;<span class="comment">// 默认安装到手机内部</span></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stat</span> sb;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-s&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 如果参数中带&#x27;-s&#x27;，则安装到SD卡</span></span><br><span class="line">            where = SD_DEST;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find last APK argument.</span></span><br><span class="line">    <span class="comment">// All other arguments passed through verbatim.</span></span><br><span class="line">    <span class="comment">//解析最后一个参数，判断adb命令中是否携带有效的apk文件名</span></span><br><span class="line">    <span class="type">int</span> last_apk = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = argc - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* file = argv[i];</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* dot = <span class="built_in">strrchr</span>(file, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (dot &amp;&amp; !<span class="built_in">strcasecmp</span>(dot, <span class="string">&quot;.apk&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">stat</span>(file, &amp;sb) == <span class="number">-1</span> || !<span class="built_in">S_ISREG</span>(sb.st_mode)) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Invalid APK file: %s\n&quot;</span>, file);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            last_apk = i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (last_apk == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Missing APK file\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> result = <span class="number">-1</span>;</span><br><span class="line">    std::vector&lt;<span class="type">const</span> <span class="type">char</span>*&gt; apk_file = &#123;argv[last_apk]&#125;;<span class="comment">// 取出apk名</span></span><br><span class="line">    std::string apk_dest = android::base::<span class="built_in">StringPrintf</span>(</span><br><span class="line">        where, <span class="built_in">adb_basename</span>(argv[last_apk]).<span class="built_in">c_str</span>());<span class="comment">// 构造apk目的地址</span></span><br><span class="line">    <span class="comment">// do_sync_push将APK文件传输到手机目标路基，失败的话跳转到cleanup_apk</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">do_sync_push</span>(apk_file, apk_dest.<span class="built_in">c_str</span>())) <span class="keyword">goto</span> cleanup_apk;</span><br><span class="line">    argv[last_apk] = apk_dest.<span class="built_in">c_str</span>(); <span class="comment">/* destination name, not source location */</span></span><br><span class="line">    result = <span class="built_in">pm_command</span>(transport, serial, argc, argv);<span class="comment">// </span></span><br><span class="line"></span><br><span class="line">cleanup_apk:</span><br><span class="line">    <span class="comment">// 删除传输失败的文件</span></span><br><span class="line">    <span class="comment">// PKMS在安装过程中会将APK复制一份到/data/app目录下，所以/data/local/tmp目录下的对应文件可以删除</span></span><br><span class="line">    <span class="built_in">delete_file</span>(transport, serial, apk_dest);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从代码中看出<code>install_app_legacy</code>就是将源机器中的APK文件传输到目的手机的tmp目录下，然后调用pm_command进行处理。</p>
<h3 id="2-pm-command"><a href="#2-pm-command" class="headerlink" title="2. pm_command"></a>2. pm_command</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">pm_command</span><span class="params">(TransportType transport, <span class="type">const</span> <span class="type">char</span>* serial, <span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    std::string cmd = <span class="string">&quot;pm&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (argc-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 根据参数argv构造pm命令</span></span><br><span class="line">        cmd += <span class="string">&quot; &quot;</span> + <span class="built_in">escape_arg</span>(*argv++);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向adbd发送shell命令</span></span><br><span class="line">    <span class="comment">// 手机端的adbd在收到客户端发来的shell pm命令时会启动一个shell，然后在其中执行pm</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">send_shell_command</span>(transport, serial, cmd, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line">... ...</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">send_shell_command</span><span class="params">(TransportType transport_type, <span class="type">const</span> <span class="type">char</span>* serial, <span class="type">const</span> std::string&amp; command, <span class="type">bool</span> disable_shell_protocol, StandardStreamsCallbackInterface* callback)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">bool</span> use_shell_protocol = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="type">bool</span> attempt_connection = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use shell protocol if it&#x27;s supported and the caller doesn&#x27;t explicitly</span></span><br><span class="line">        <span class="comment">// disable it.</span></span><br><span class="line">        <span class="comment">// 如果支持shell协议，并且调用者没有明确禁用它，则使用shell协议</span></span><br><span class="line">        <span class="keyword">if</span> (!disable_shell_protocol) &#123;</span><br><span class="line">            FeatureSet features;</span><br><span class="line">            std::string error;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">adb_get_feature_set</span>(&amp;features, &amp;error)) &#123;</span><br><span class="line">                <span class="comment">// 如果定义了Feature，则使用shell协议</span></span><br><span class="line">                use_shell_protocol = <span class="built_in">CanUseFeature</span>(features, kFeatureShell2);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Device was unreachable.</span></span><br><span class="line">                attempt_connection = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (attempt_connection) &#123;</span><br><span class="line">            std::string error;</span><br><span class="line">            <span class="comment">// command已是pm开头的命令</span></span><br><span class="line">            std::string service_string = <span class="built_in">ShellServiceString</span>(use_shell_protocol, <span class="string">&quot;&quot;</span>, command);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 向shell服务发送命令</span></span><br><span class="line">            fd = <span class="built_in">adb_connect</span>(service_string, &amp;error);</span><br><span class="line">            <span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;- waiting for device -\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">wait_for_device</span>(<span class="string">&quot;wait-for-device&quot;</span>, transport_type, serial)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> exit_code = <span class="built_in">read_and_dump</span>(fd, use_shell_protocol, callback);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">adb_close</span>(fd) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">PLOG</span>(ERROR) &lt;&lt; <span class="string">&quot;failure closing FD &quot;</span> &lt;&lt; fd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> exit_code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从代码可知，pm_command就是向shell服务发送pm命令。</p>
<p>pm实际上是一个脚本，定义在<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/">&#x2F;frameworks&#x2F;base&#x2F;cmds&#x2F;pm&#x2F;</a> 中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Script to start <span class="string">&quot;pm&quot;</span> on the device, <span class="built_in">which</span> has a very rudimentary</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">shell.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">base=/system</span></span><br><span class="line">export CLASSPATH=$base/framework/pm.jar</span><br><span class="line">exec app_process $base/bin com.android.commands.pm.Pm &quot;$@&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$@</span> 表示传给脚本的所有参数的列表</span></span><br></pre></td></tr></table></figure>

<p>在编译system.img时，<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/">cmds</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/Android.mk">Android.mk</a> 中会将该脚本复制到<code>system/bin</code>目录下。从脚本内容来看，首先export pm.jar到环境变量，然后通过app_process去执行pm.jar包中的main函数并将参数传给main函数，即&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/">cmds</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/">src</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/">com</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/commands/">commands</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/commands/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/commands/pm/Pm.java">Pm.java</a> 中的main函数，根据不同参数处理不同事件。app_process是一个native进程，它通过创建虚拟机启动了Zygote，从而转变为一个Java进程，接下来我们看如何从执行pm脚本到启动Java进程。</p>
<p>app_process参数格式如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app_process [vm-options] cmd-dir [options] start-class-name [main-options]</span><br></pre></td></tr></table></figure>

<ul>
<li>vm-options：虚拟机选项参数</li>
<li>cmd-dir：当前未使用的父目录（如上述&#x2F;system&#x2F;bin），文件操作的父路径将为此路径</li>
<li>options：<ul>
<li>–zygote：以zygote模式开始</li>
<li>–start-system-server：启动System Server</li>
<li>–application：以应用模式（独立，非zygote）开始</li>
<li>–nice-name：这个进程的名字（应该是启动后的正式名字吧？）</li>
</ul>
</li>
<li>start-class-name：包含main方法的主类</li>
<li>main-options：对于非zygote开始的，options参数后面跟着主类名称，所有剩余的参数传递给这个类的main方法，对于zygote开始的，所有剩余参数都将传递给zygote</li>
</ul>
<p>首先看&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/">cmds</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/app_process/">app_process</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/app_process/app_main.cpp">app_main.cpp</a> 的main函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* const argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (prctl(PR_SET_NO_NEW_PRIVS, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Older kernels don&#x27;t understand PR_SET_NO_NEW_PRIVS and return</span></span><br><span class="line">        <span class="comment">// EINVAL. Don&#x27;t die on such kernels.</span></span><br><span class="line">        <span class="keyword">if</span> (errno != EINVAL) &#123;</span><br><span class="line">            LOG_ALWAYS_FATAL(<span class="string">&quot;PR_SET_NO_NEW_PRIVS failed: %s&quot;</span>, strerror(errno));</span><br><span class="line">            <span class="keyword">return</span> <span class="number">12</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    AppRuntime <span class="title function_">runtime</span><span class="params">(argv[<span class="number">0</span>], computeArgBlockSize(argc, argv)</span>);</span><br><span class="line">    <span class="comment">// Process command line arguments</span></span><br><span class="line">    <span class="comment">// ignore argv[0]（argv[0]应该就是指app_process吧）</span></span><br><span class="line">    argc--;</span><br><span class="line">    argv++;</span><br><span class="line">    <span class="comment">// Everything up to &#x27;--&#x27; or first non &#x27;-&#x27; arg goes to the vm.</span></span><br><span class="line">    <span class="comment">// 把&#x27;--&#x27;开头之前的参数，或者第一个非&#x27;-&#x27;开头的参数传递给虚拟机</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// The first argument after the VM args is the &quot;parent dir&quot;, which</span></span><br><span class="line">    <span class="comment">// is currently unused.</span></span><br><span class="line">    <span class="comment">// 虚拟机参数之后的第一个参数是当前未使用的“父目录”</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// After the parent dir, we expect one or more the following internal</span></span><br><span class="line">    <span class="comment">// arguments :</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// --zygote : Start in zygote mode</span></span><br><span class="line">    <span class="comment">// --start-system-server : Start the system server.</span></span><br><span class="line">    <span class="comment">// --application : Start in application (stand alone, non zygote) mode.</span></span><br><span class="line">    <span class="comment">// --nice-name : The nice name for this process.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// For non zygote starts, these arguments will be followed by</span></span><br><span class="line">    <span class="comment">// the main class name. All remaining arguments are passed to</span></span><br><span class="line">    <span class="comment">// the main method of this class.</span></span><br><span class="line">    <span class="comment">// 对于非zygote开始的，这些参数后面跟着主类名称，所有剩余的参数传递给这个类的main方法</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// For zygote starts, all remaining arguments are passed to the zygote.</span></span><br><span class="line">    <span class="comment">// main function.</span></span><br><span class="line">    <span class="comment">// 对于zygote开始的，所有剩余参数都将传递给zygote</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Note that we must copy argument string values since we will rewrite the</span></span><br><span class="line">    <span class="comment">// entire argument block when we apply the nice name to argv0.</span></span><br><span class="line">    <span class="comment">// 请注意，我们必须复制参数字符串值，因为当我们将nice名称应用于argv0（app_process？）时，我们将重写</span></span><br><span class="line">    <span class="comment">// 整个参数块。</span></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (argv[i][<span class="number">0</span>] != <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;<span class="comment">// 不是以&#x27;-&#x27;开头，跳出循环</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (argv[i][<span class="number">1</span>] == <span class="string">&#x27;-&#x27;</span> &amp;&amp; argv[i][<span class="number">2</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">            ++i; <span class="comment">// Skip --.</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        runtime.addOption(strdup(argv[i]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Parse runtime arguments.  Stop at first unrecognized option.</span></span><br><span class="line">    <span class="type">bool</span> <span class="variable">zygote</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">bool</span> <span class="variable">startSystemServer</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">bool</span> <span class="variable">application</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    String8 niceName;</span><br><span class="line">    String8 className;</span><br><span class="line">    ++i;  <span class="comment">// Skip unused &quot;parent dir&quot; argument.</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt; argc) &#123;</span><br><span class="line">        const <span class="type">char</span>* arg = argv[i++];</span><br><span class="line">        <span class="keyword">if</span> (strcmp(arg, <span class="string">&quot;--zygote&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            zygote = <span class="literal">true</span>;</span><br><span class="line">            niceName = ZYGOTE_NICE_NAME;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(arg, <span class="string">&quot;--start-system-server&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            startSystemServer = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(arg, <span class="string">&quot;--application&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            application = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strncmp(arg, <span class="string">&quot;--nice-name=&quot;</span>, <span class="number">12</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            niceName.setTo(arg + <span class="number">12</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strncmp(arg, <span class="string">&quot;--&quot;</span>, <span class="number">2</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果arg的前2个字符不为&quot;--&quot;，进入该条件分支设置className</span></span><br><span class="line">            className.setTo(arg);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            --i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ...</span><br><span class="line">    &#125;</span><br><span class="line">    ... ...</span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">        runtime.start(<span class="string">&quot;com.android.internal.os.ZygoteInit&quot;</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">        <span class="comment">// 不是启动zygote，而是启动className对应的类RuntimeInit</span></span><br><span class="line">        runtime.start(<span class="string">&quot;com.android.internal.os.RuntimeInit&quot;</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fprintf(stderr, <span class="string">&quot;Error: no class name or --zygote supplied.\n&quot;</span>);</span><br><span class="line">        app_usage();</span><br><span class="line">        LOG_ALWAYS_FATAL(<span class="string">&quot;app_process: no class name or --zygote supplied.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/">core</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/jni/">jni</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/jni/AndroidRuntime.cpp">AndroidRuntime.cpp</a> </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AndroidRuntime::start</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* className, <span class="type">const</span> Vector&lt;String8&gt;&amp; options, <span class="type">bool</span> zygote)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ... ...</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Start VM.  This thread becomes the main thread of the VM, and will</span></span><br><span class="line"><span class="comment">     * not return until the VM exits.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">char</span>* slashClassName = <span class="built_in">toSlashClassName</span>(className);</span><br><span class="line">    jclass startClass = env-&gt;<span class="built_in">FindClass</span>(slashClassName);</span><br><span class="line">    <span class="keyword">if</span> (startClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">ALOGE</span>(<span class="string">&quot;JavaVM unable to locate class &#x27;%s&#x27;\n&quot;</span>, slashClassName);</span><br><span class="line">        <span class="comment">/* keep going */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        jmethodID startMeth = env-&gt;<span class="built_in">GetStaticMethodID</span>(startClass, <span class="string">&quot;main&quot;</span>,</span><br><span class="line">            <span class="string">&quot;([Ljava/lang/String;)V&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (startMeth == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">ALOGE</span>(<span class="string">&quot;JavaVM unable to find main() in &#x27;%s&#x27;\n&quot;</span>, className);</span><br><span class="line">            <span class="comment">/* keep going */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 反射调用main函数，从native层进入java世界</span></span><br><span class="line">            env-&gt;<span class="built_in">CallStaticVoidMethod</span>(startClass, startMeth, strArray);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">            <span class="keyword">if</span> (env-&gt;<span class="built_in">ExceptionCheck</span>())</span><br><span class="line">                <span class="built_in">threadExitUncaughtException</span>(env);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(slashClassName);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ALOGD</span>(<span class="string">&quot;Shutting down VM\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (mJavaVM-&gt;<span class="built_in">DetachCurrentThread</span>() != JNI_OK)</span><br><span class="line">        <span class="built_in">ALOGW</span>(<span class="string">&quot;Warning: unable to detach main thread\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (mJavaVM-&gt;<span class="built_in">DestroyJavaVM</span>() != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">ALOGW</span>(<span class="string">&quot;Warning: VM did not shut down cleanly\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>start方法通过反射启动RuntimeInit类，进入到RuntimeInit的main函数：</p>
<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/">core</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/">java</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/com/">com</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/com/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/com/android/internal/">internal</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/com/android/internal/os/">os</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/com/android/internal/os/RuntimeInit.java">RuntimeInit.java</a> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> &#123;</span><br><span class="line">    enableDdms();</span><br><span class="line">    <span class="keyword">if</span> (argv.length == <span class="number">2</span> &amp;&amp; argv[<span class="number">1</span>].equals(<span class="string">&quot;application&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">&quot;RuntimeInit: Starting application&quot;</span>);</span><br><span class="line">        redirectLogStreams();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">&quot;RuntimeInit: Starting tool&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    commonInit();<span class="comment">// 进行一些常规的初始化工作</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Now that we&#x27;re running in interpreted code, call back into native code</span></span><br><span class="line"><span class="comment">     * to run the system.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    nativeFinishInit();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">&quot;Leaving RuntimeInit!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>nativeFinishInit函数如下：</p>
<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/">core</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/jni/">jni</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/jni/AndroidRuntime.cpp">AndroidRuntime.cpp</a> </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> AndroidRuntime* gCurRuntime = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Code written in the Java Programming Language calls here from main().</span></span><br><span class="line"><span class="comment"> * 从用java写的RuntimeInit的main函数调用此处</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">com_android_internal_os_RuntimeInit_nativeFinishInit</span><span class="params">(JNIEnv* env, jobject clazz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    gCurRuntime-&gt;<span class="built_in">onStarted</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>app_main.cpp中定义的AppRuntime继承AndroidRuntime，实现onStarted函数：</p>
<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/">cmds</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/app_process/">app_process</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/app_process/app_main.cpp">app_main.cpp</a> </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AppRuntime</span> : <span class="keyword">public</span> AndroidRuntime</span><br><span class="line">&#123;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">onStarted</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        sp&lt;ProcessState&gt; proc = ProcessState::<span class="built_in">self</span>();</span><br><span class="line">        <span class="built_in">ALOGV</span>(<span class="string">&quot;App process: starting thread pool.\n&quot;</span>);</span><br><span class="line">        proc-&gt;<span class="built_in">startThreadPool</span>();</span><br><span class="line"></span><br><span class="line">        AndroidRuntime* ar = AndroidRuntime::<span class="built_in">getRuntime</span>();</span><br><span class="line">        <span class="comment">// 调用AndroidRuntime.callMain函数</span></span><br><span class="line">        ar-&gt;<span class="built_in">callMain</span>(mClassName, mClass, mArgs);</span><br><span class="line"></span><br><span class="line">        IPCThreadState::<span class="built_in">self</span>()-&gt;<span class="built_in">stopProcess</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/">core</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/jni/">jni</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/jni/AndroidRuntime.cpp">AndroidRuntime.cpp</a> </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">AndroidRuntime::callMain</span><span class="params">(<span class="type">const</span> String8&amp; className, jclass clazz,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> Vector&lt;String8&gt;&amp; args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    jmethodID methodId;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ALOGD</span>(<span class="string">&quot;Calling main entry %s&quot;</span>, className.<span class="built_in">string</span>());</span><br><span class="line"></span><br><span class="line">    env = <span class="built_in">getJNIEnv</span>();</span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">NULL</span> || env == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> UNKNOWN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    methodId = env-&gt;<span class="built_in">GetStaticMethodID</span>(clazz, <span class="string">&quot;main&quot;</span>, <span class="string">&quot;([Ljava/lang/String;)V&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (methodId == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">ALOGE</span>(<span class="string">&quot;ERROR: could not find method %s.main(String[])\n&quot;</span>, className.<span class="built_in">string</span>());</span><br><span class="line">        <span class="keyword">return</span> UNKNOWN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * We want to call main() with a String array with our arguments in it.</span></span><br><span class="line"><span class="comment">     * Create an array and populate it.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    jclass stringClass;</span><br><span class="line">    jobjectArray strArray;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> numArgs = args.<span class="built_in">size</span>();</span><br><span class="line">    stringClass = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;java/lang/String&quot;</span>);</span><br><span class="line">    strArray = env-&gt;<span class="built_in">NewObjectArray</span>(numArgs, stringClass, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; numArgs; i++) &#123;</span><br><span class="line">        jstring argStr = env-&gt;<span class="built_in">NewStringUTF</span>(args[i].<span class="built_in">string</span>());</span><br><span class="line">        env-&gt;<span class="built_in">SetObjectArrayElement</span>(strArray, i, argStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后在此处调用Pm.java的main函数</span></span><br><span class="line">    env-&gt;<span class="built_in">CallStaticVoidMethod</span>(clazz, methodId, strArray);</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-Pm-java流程"><a href="#3-Pm-java流程" class="headerlink" title="3. Pm.java流程"></a>3. Pm.java流程</h3><p>进入Pm.java的main函数：</p>
<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/">cmds</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/">src</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/">com</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/commands/">commands</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/commands/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/commands/pm/Pm.java">Pm.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String[] mArgs;</span><br><span class="line">IPackageInstaller mInstaller;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        exitCode = <span class="keyword">new</span> <span class="title class_">Pm</span>().run(args); <span class="comment">// 调用run方法</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;Error&quot;</span>, e);</span><br><span class="line">        System.err.println(<span class="string">&quot;Error: &quot;</span> + e);</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RemoteException) &#123;</span><br><span class="line">            System.err.println(PM_NOT_RUNNING_ERR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.exit(exitCode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">run</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">validCommand</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (args.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果没有参数，则显示命令用法</span></span><br><span class="line">        <span class="keyword">return</span> showUsage();</span><br><span class="line">    &#125;</span><br><span class="line">    mAm = IAccountManager.Stub.asInterface(ServiceManager.getService(Context.ACCOUNT_SERVICE));</span><br><span class="line">    mUm = IUserManager.Stub.asInterface(ServiceManager.getService(Context.USER_SERVICE));</span><br><span class="line">    <span class="comment">// 利用Binder通信，得到PKMS服务端代理</span></span><br><span class="line">    mPm = IPackageManager.Stub.asInterface(ServiceManager.getService(<span class="string">&quot;package&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mPm == <span class="literal">null</span>) &#123;</span><br><span class="line">        System.err.println(PM_NOT_RUNNING_ERR);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// getPackageInstaller()在PKMS中实现，返回的是final PackageInstallerService mInstallerService;</span></span><br><span class="line">    mInstaller = mPm.getPackageInstaller();</span><br><span class="line"></span><br><span class="line">    mArgs = args;</span><br><span class="line">    <span class="type">String</span> <span class="variable">op</span> <span class="operator">=</span> args[<span class="number">0</span>];</span><br><span class="line">    mNextArg = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;list&quot;</span>.equals(op)) &#123;</span><br><span class="line">        <span class="keyword">return</span> runList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;path&quot;</span>.equals(op)) &#123;</span><br><span class="line">        <span class="keyword">return</span> runPath();</span><br><span class="line">    &#125;</span><br><span class="line">  ... ...</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;install&quot;</span>.equals(op)) &#123;</span><br><span class="line">        <span class="comment">// 这里我们是安装，则调用runInstall</span></span><br><span class="line">        <span class="keyword">return</span> runInstall();</span><br><span class="line">    &#125;</span><br><span class="line">  ... ...</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;uninstall&quot;</span>.equals(op)) &#123;</span><br><span class="line">        <span class="comment">// 如果是卸载则调用runUnistall</span></span><br><span class="line">        <span class="keyword">return</span> runUninstall();</span><br><span class="line">    &#125;</span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来看runInstall函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Keep this around to support existing users of the &quot;pm install&quot; command that may not be</span></span><br><span class="line"><span class="comment"> * able to be updated [or, at least informed the API has changed] such as ddmlib.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Moving the implementation of &quot;pm install&quot; to &quot;cmd package install&quot; changes the executing</span></span><br><span class="line"><span class="comment"> * context. Instead of being a stand alone process, &quot;cmd package install&quot; runs in the</span></span><br><span class="line"><span class="comment"> * system_server process. Due to SELinux rules, system_server cannot access many directories;</span></span><br><span class="line"><span class="comment"> * one of which being the package install staging directory [/data/local/tmp].</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The use of &quot;adb install&quot; or &quot;cmd package install&quot; over &quot;pm install&quot; is highly encouraged.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">runInstall</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="comment">// 根据install后面的参数创建InstallParams，也包含了SessionParams，标志为MODE_FULL_INSTALL</span></span><br><span class="line">    <span class="comment">// Mode for an install session whose staged APKs should fully replace any existing APKs for the target app.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">InstallParams</span> <span class="variable">params</span> <span class="operator">=</span> makeInstallParams();</span><br><span class="line">    <span class="comment">// InstallParams之后的参数，就是所要安装的APK文件，即inPath</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">inPath</span> <span class="operator">=</span> nextArg();</span><br><span class="line">    <span class="comment">// 是否安装到外置存储</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">installExternal</span> <span class="operator">=</span></span><br><span class="line">            (params.sessionParams.installFlags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (params.sessionParams.sizeBytes &lt; <span class="number">0</span> &amp;&amp; inPath != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(inPath);</span><br><span class="line">        <span class="keyword">if</span> (file.isFile()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (installExternal) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">ApkLite</span> <span class="variable">baseApk</span> <span class="operator">=</span> PackageParser.parseApkLite(file, <span class="number">0</span>);</span><br><span class="line">                    <span class="type">PackageLite</span> <span class="variable">pkgLite</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageLite</span>(<span class="literal">null</span>, baseApk, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">                    params.sessionParams.setSize(</span><br><span class="line">                            PackageHelper.calculateInstalledSize(pkgLite, <span class="literal">false</span>,</span><br><span class="line">                                    params.sessionParams.abiOverride));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (PackageParserException | IOException e) &#123;</span><br><span class="line">                    System.err.println(<span class="string">&quot;Error: Failed to parse APK file : &quot;</span> + e);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                params.sessionParams.setSize(file.length());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1 Create Session</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">sessionId</span> <span class="operator">=</span> doCreateSession(params.sessionParams,</span><br><span class="line">            params.installerPackageName, params.userId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (inPath == <span class="literal">null</span> &amp;&amp; params.sessionParams.sizeBytes == <span class="number">0</span>) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Error: must either specify a package size or an APK file&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2 Write Session</span></span><br><span class="line">        <span class="keyword">if</span> (doWriteSession(sessionId, inPath, params.sessionParams.sizeBytes, <span class="string">&quot;base.apk&quot;</span>,</span><br><span class="line">                <span class="literal">false</span> <span class="comment">/*logSuccess*/</span>) != PackageInstaller.STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3 Commit Session</span></span><br><span class="line">        <span class="keyword">if</span> (doCommitSession(sessionId, <span class="literal">false</span> <span class="comment">/*logSuccess*/</span>)</span><br><span class="line">                != PackageInstaller.STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 安装成功打印&quot;Success&quot;</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mInstaller.abandonSession(sessionId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从代码中看，runInstall方法主要做了三件事：创建Session、对Session进行写操作以及提交Session，接下来看每一步的详细工作。</p>
<h4 id="3-1-Create-Session"><a href="#3-1-Create-Session" class="headerlink" title="3.1 Create Session"></a>3.1 Create Session</h4><p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/">cmds</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/">src</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/">com</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/commands/">commands</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/commands/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/commands/pm/Pm.java">Pm.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">doCreateSession</span><span class="params">(SessionParams params, String installerPackageName, <span class="type">int</span> userId)</span></span><br><span class="line">        <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="comment">// 通过AMS得到&quot;runInstallCreate&quot;(作为Context对应的字符串)对应的uid</span></span><br><span class="line">    userId = translateUserId(userId, <span class="string">&quot;runInstallCreate&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (userId == UserHandle.USER_ALL) &#123;</span><br><span class="line">        userId = UserHandle.USER_SYSTEM;</span><br><span class="line">        params.installFlags |= PackageManager.INSTALL_ALL_USERS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过mInstaller(IPackageInstaller)，即通过PakcageInstallerService创建Session</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">sessionId</span> <span class="operator">=</span> mInstaller.createSession(params, installerPackageName, userId);</span><br><span class="line">    <span class="keyword">return</span> sessionId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看PackageInstallerService中的createSession函数：</p>
<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/">services</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/">core</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/">java</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/">com</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/">server</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/pm/PackageInstallerService.java">PackageInstallerService.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">createSession</span><span class="params">(SessionParams params, String installerPackageName, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createSessionInternal(params, installerPackageName, userId);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ExceptionUtils.wrap(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">createSessionInternal</span><span class="params">(SessionParams params, String installerPackageName, <span class="type">int</span> userId)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">callingUid</span> <span class="operator">=</span> Binder.getCallingUid();</span><br><span class="line">    mPm.enforceCrossUserPermission(callingUid, userId, <span class="literal">true</span>, <span class="literal">true</span>, <span class="string">&quot;createSession&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mPm.isUserRestricted(userId, UserManager.DISALLOW_INSTALL_APPS)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;User restriction prevents installing&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改SessionParams的installFlags</span></span><br><span class="line">    <span class="keyword">if</span> ((callingUid == Process.SHELL_UID) || (callingUid == Process.ROOT_UID)) &#123;</span><br><span class="line">        params.installFlags |= PackageManager.INSTALL_FROM_ADB;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mAppOps.checkPackage(callingUid, installerPackageName);</span><br><span class="line"></span><br><span class="line">        params.installFlags &amp;= ~PackageManager.INSTALL_FROM_ADB;</span><br><span class="line">        params.installFlags &amp;= ~PackageManager.INSTALL_ALL_USERS;</span><br><span class="line">        params.installFlags |= PackageManager.INSTALL_REPLACE_EXISTING;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Only system components can circumvent runtime permissions when installing.</span></span><br><span class="line">    <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_GRANT_RUNTIME_PERMISSIONS) != <span class="number">0</span></span><br><span class="line">            &amp;&amp; mContext.checkCallingOrSelfPermission(Manifest.permission</span><br><span class="line">            .INSTALL_GRANT_RUNTIME_PERMISSIONS) == PackageManager.PERMISSION_DENIED) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;You need the &quot;</span></span><br><span class="line">                + <span class="string">&quot;android.permission.INSTALL_GRANT_RUNTIME_PERMISSIONS permission &quot;</span></span><br><span class="line">                + <span class="string">&quot;to use the PackageManager.INSTALL_GRANT_RUNTIME_PERMISSIONS flag&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Defensively resize giant app icons</span></span><br><span class="line">    <span class="comment">// 调整app图标大小</span></span><br><span class="line">    <span class="keyword">if</span> (params.appIcon != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ActivityManager</span> <span class="variable">am</span> <span class="operator">=</span> (ActivityManager) mContext.getSystemService(</span><br><span class="line">                Context.ACTIVITY_SERVICE);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">iconSize</span> <span class="operator">=</span> am.getLauncherLargeIconSize();</span><br><span class="line">        <span class="keyword">if</span> ((params.appIcon.getWidth() &gt; iconSize * <span class="number">2</span>)</span><br><span class="line">                || (params.appIcon.getHeight() &gt; iconSize * <span class="number">2</span>)) &#123;</span><br><span class="line">            params.appIcon = Bitmap.createScaledBitmap(params.appIcon, iconSize, iconSize,</span><br><span class="line">                    <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (params.mode) &#123;</span><br><span class="line">        <span class="keyword">case</span> SessionParams.MODE_FULL_INSTALL:</span><br><span class="line">        <span class="keyword">case</span> SessionParams.MODE_INHERIT_EXISTING:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Invalid install mode: &quot;</span> + params.mode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If caller requested explicit location, sanity check it, otherwise</span></span><br><span class="line">    <span class="comment">// resolve the best internal or adopted location.</span></span><br><span class="line">    <span class="comment">// 根据SessionParams的installFlags进行一些操作</span></span><br><span class="line">    <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_INTERNAL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!PackageHelper.fitsOnInternal(mContext, params.sizeBytes)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;No suitable internal storage available&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!PackageHelper.fitsOnExternal(mContext, params.sizeBytes)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;No suitable external storage available&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_FORCE_VOLUME_UUID) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// For now, installs to adopted media are treated as internal from</span></span><br><span class="line">        <span class="comment">// an install flag point-of-view.</span></span><br><span class="line">        params.setInstallFlagsInternal();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 通过adb安装会进入到这个分支，为SessionParams设置InstallInternal Flag</span></span><br><span class="line">        <span class="comment">// For now, installs to adopted media are treated as internal from</span></span><br><span class="line">        <span class="comment">// an install flag point-of-view.</span></span><br><span class="line">        params.setInstallFlagsInternal();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Resolve best location for install, based on combination of</span></span><br><span class="line">        <span class="comment">// requested install flags, delta size, and manifest settings.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">ident</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            params.volumeUuid = PackageHelper.resolveInstallVolume(mContext,</span><br><span class="line">                    params.appPackageName, params.installLocation, params.sizeBytes);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(ident);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> sessionId;</span><br><span class="line">    <span class="keyword">final</span> PackageInstallerSession session;</span><br><span class="line">    <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">        <span class="comment">// Sanity check that installer isn&#x27;t going crazy</span></span><br><span class="line">        <span class="comment">// 确保同一个uid没有提交过多的活动Session，MAX_ACTIVE_SESSIONS=1024</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">activeCount</span> <span class="operator">=</span> getSessionCount(mSessions, callingUid);</span><br><span class="line">        <span class="keyword">if</span> (activeCount &gt;= MAX_ACTIVE_SESSIONS) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                    <span class="string">&quot;Too many active sessions for UID &quot;</span> + callingUid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 确保同一个uid没有提交过多的历史Session，MAX_HISTORICAL_SESSIONS=1048576</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">historicalCount</span> <span class="operator">=</span> getSessionCount(mHistoricalSessions, callingUid);</span><br><span class="line">        <span class="keyword">if</span> (historicalCount &gt;= MAX_HISTORICAL_SESSIONS) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                    <span class="string">&quot;Too many historical sessions for UID &quot;</span> + callingUid);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sessionId = allocateSessionIdLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">createdMillis</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// We&#x27;re staging to exactly one location</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">stageDir</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">stageCid</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 根据installFlags决定安装目录，默认安装到internal目录下</span></span><br><span class="line">    <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_INTERNAL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isEphemeral</span> <span class="operator">=</span></span><br><span class="line">                (params.installFlags &amp; PackageManager.INSTALL_EPHEMERAL) != <span class="number">0</span>;</span><br><span class="line">        stageDir = buildStageDir(params.volumeUuid, sessionId, isEphemeral);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        stageCid = buildExternalStageCid(sessionId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    session = <span class="keyword">new</span> <span class="title class_">PackageInstallerSession</span>(mInternalCallback, mContext, mPm,</span><br><span class="line">            mInstallThread.getLooper(), sessionId, userId, installerPackageName, callingUid,</span><br><span class="line">            params, createdMillis, stageDir, stageCid, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">        mSessions.put(sessionId, session);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 回调通知Session已经create</span></span><br><span class="line">    mCallbacks.notifySessionCreated(session.sessionId, session.userId);</span><br><span class="line">    <span class="comment">// 在mSessionsFile中记录</span></span><br><span class="line">    writeSessionsAsync();</span><br><span class="line">    <span class="keyword">return</span> sessionId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从代码中可知creatSession主要工作就是为APK的安装做好准备工作，最终创建出PackageInstallerSession对象，这个对象可以看作是“安装APK”这个请求的封装，其中包含了处理这个请求需要的一些信息。</p>
<h4 id="3-2-Write-Session"><a href="#3-2-Write-Session" class="headerlink" title="3.2 Write Session"></a>3.2 Write Session</h4><p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/">cmds</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/">src</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/">com</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/commands/">commands</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/commands/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/commands/pm/Pm.java">Pm.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">doWriteSession</span><span class="params">(<span class="type">int</span> sessionId, String inPath, <span class="type">long</span> sizeBytes, String splitName,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> logSuccess)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;-&quot;</span>.equals(inPath)) &#123;</span><br><span class="line">        inPath = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inPath != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// file指向待安装的apk文件</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(inPath);</span><br><span class="line">        <span class="keyword">if</span> (file.isFile()) &#123;</span><br><span class="line">            sizeBytes = file.length();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">SessionInfo</span> <span class="variable">info</span> <span class="operator">=</span> mInstaller.getSessionInfo(sessionId);</span><br><span class="line"></span><br><span class="line">    PackageInstaller.<span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">OutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 获取PakcageInstallerSession的调用接口</span></span><br><span class="line">        session = <span class="keyword">new</span> <span class="title class_">PackageInstaller</span>.Session(</span><br><span class="line">                mInstaller.openSession(sessionId));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (inPath != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 定义输入端，待安装apk对应文件的源地址</span></span><br><span class="line">            in = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(inPath);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            in = <span class="keyword">new</span> <span class="title class_">SizedInputStream</span>(System.in, sizeBytes);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 定义输出端，对应copy后的目的地址</span></span><br><span class="line">        out = session.openWrite(splitName, <span class="number">0</span>, sizeBytes);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">total</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">65536</span>];</span><br><span class="line">        <span class="type">int</span> c;</span><br><span class="line">        <span class="comment">// 开始copy文件</span></span><br><span class="line">        <span class="keyword">while</span> ((c = in.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            total += c;</span><br><span class="line">            out.write(buffer, <span class="number">0</span>, c);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (info.sizeBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">float</span> <span class="variable">fraction</span> <span class="operator">=</span> ((<span class="type">float</span>) c / (<span class="type">float</span>) info.sizeBytes);</span><br><span class="line">                <span class="comment">// 更新copy的进度（c为已copy的，info.sizeBytes为总的）</span></span><br><span class="line">                session.addProgress(fraction);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        session.fsync(out);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (logSuccess) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Success: streamed &quot;</span> + total + <span class="string">&quot; bytes&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> PackageInstaller.STATUS_SUCCESS;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;Error: failed to write; &quot;</span> + e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> PackageInstaller.STATUS_FAILURE;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(out);</span><br><span class="line">        IoUtils.closeQuietly(in);</span><br><span class="line">        IoUtils.closeQuietly(session);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从代码看此段代码主要作用是通过Session将源端的数据copy到目的端。</p>
<p>整个执行过程是基于C&#x2F;S架构的通信工程，PackageInstallerSession是服务端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PackageInstallerSession</span> <span class="keyword">extends</span> <span class="title class_">IPackageInstallerSession</span>.Stub &#123;</span><br></pre></td></tr></table></figure>

<p>Pm作为PackageInstallerService的客户端，利用PackageInstallerSession来封装每一次完整的通信过程。</p>
<h5 id="3-2-1-得到PackageInstallerSession的代理对象"><a href="#3-2-1-得到PackageInstallerSession的代理对象" class="headerlink" title="3.2.1 得到PackageInstallerSession的代理对象"></a>3.2.1 得到PackageInstallerSession的代理对象</h5><p>在Write Session中通过<code>session = new PackageInstaller.Session(mInstaller.openSession(sessionId));</code>获取了PackageInstallerSession的调用接口，PackageInstaller.Session的构造函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Session</span> <span class="keyword">implements</span> <span class="title class_">Closeable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> IPackageInstallerSession mSession;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Session</span><span class="params">(IPackageInstallerSession session)</span> &#123;</span><br><span class="line">        mSession = session;</span><br><span class="line">    &#125;</span><br><span class="line">... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>传入的参数是<code>mInstaller.openSession(sessionId)</code>，mInstaller是在Pm.java中定义的，<code>IPackageInstaller mInstaller;</code>，<code>mInstaller = mPm.getPackageInstaller();</code>，最终返回的是<code>final PackageInstallerService mInstallerService;</code> ，来看一下PackageInstallerService.openSession函数：</p>
<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/">services</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/">core</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/">java</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/">com</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/">server</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/pm/PackageInstallerService.java">PackageInstallerService.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> IPackageInstallerSession <span class="title function_">openSession</span><span class="params">(<span class="type">int</span> sessionId)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> openSessionInternal(sessionId);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ExceptionUtils.wrap(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> IPackageInstallerSession <span class="title function_">openSessionInternal</span><span class="params">(<span class="type">int</span> sessionId)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">        <span class="comment">// 根据sessionId获得PackageInstallerSession</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">PackageInstallerSession</span> <span class="variable">session</span> <span class="operator">=</span> mSessions.get(sessionId);</span><br><span class="line">        <span class="keyword">if</span> (session == <span class="literal">null</span> || !isCallingUidOwner(session)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Caller has no access to session &quot;</span> + sessionId);</span><br><span class="line">        &#125;</span><br><span class="line">        session.open();</span><br><span class="line">        <span class="keyword">return</span> session;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// open函数作用是准备好待copy的目录</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (mActiveCount.getAndIncrement() == <span class="number">0</span>) &#123;</span><br><span class="line">        mCallback.onSessionActiveChanged(<span class="built_in">this</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mPrepared) &#123;</span><br><span class="line">            <span class="keyword">if</span> (stageDir != <span class="literal">null</span>) &#123;</span><br><span class="line">                prepareStageDir(stageDir);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (stageCid != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">long</span> <span class="variable">identity</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    prepareExternalStageCid(stageCid, params.sizeBytes);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    Binder.restoreCallingIdentity(identity);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> deliver more granular progress for ASEC allocation</span></span><br><span class="line">                mInternalProgress = <span class="number">0.25f</span>;</span><br><span class="line">                computeProgressLocked(<span class="literal">true</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">                        <span class="string">&quot;Exactly one of stageDir or stageCid stage must be set&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mPrepared = <span class="literal">true</span>;</span><br><span class="line">            mCallback.onSessionPrepared(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-2-2-定义输出端，得到客户端"><a href="#3-2-2-定义输出端，得到客户端" class="headerlink" title="3.2.2 定义输出端，得到客户端"></a>3.2.2 定义输出端，得到客户端</h5><p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/">core</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/">java</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/android/content/">content</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/android/content/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/android/content/pm/PackageInstaller.java">PackageInstaller.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@NonNull</span> OutputStream <span class="title function_">openWrite</span><span class="params">(<span class="meta">@NonNull</span> String name, <span class="type">long</span> offsetBytes,</span></span><br><span class="line"><span class="params">        <span class="type">long</span> lengthBytes)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 调用了mSession(PackageInstallerSession对象)的openWrite方法，发生了Binder通信</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ParcelFileDescriptor</span> <span class="variable">clientSocket</span> <span class="operator">=</span> mSession.openWrite(name,</span><br><span class="line">                offsetBytes, lengthBytes);</span><br><span class="line">        <span class="comment">// 此处创建了一个FileBridge对象</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FileBridge</span>.FileBridgeOutputStream(clientSocket);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        ExceptionUtils.maybeUnwrapIOException(e);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际上就是获得输出流，对应copy后的目的地址，接下来看看PackageInstallerSession的openWrite方法。</p>
<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/">services</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/">core</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/">java</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/">com</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/">server</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/pm/PackageInstallerSession.java">PackageInstallerSession.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ParcelFileDescriptor <span class="title function_">openWrite</span><span class="params">(String name, <span class="type">long</span> offsetBytes, <span class="type">long</span> lengthBytes)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> openWriteInternal(name, offsetBytes, lengthBytes);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ExceptionUtils.wrap(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ParcelFileDescriptor <span class="title function_">openWriteInternal</span><span class="params">(String name, <span class="type">long</span> offsetBytes, <span class="type">long</span> lengthBytes)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// Quick sanity check of state, and allocate a pipe for ourselves. We</span></span><br><span class="line">    <span class="comment">// then do heavy disk allocation outside the lock, but this open pipe</span></span><br><span class="line">    <span class="comment">// will block any attempted install transitions.</span></span><br><span class="line">    <span class="comment">// FileBridge建立客户端和服务端的管道</span></span><br><span class="line">    <span class="keyword">final</span> FileBridge bridge;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        assertPreparedAndNotSealed(<span class="string">&quot;openWrite&quot;</span>);</span><br><span class="line"></span><br><span class="line">        bridge = <span class="keyword">new</span> <span class="title class_">FileBridge</span>();</span><br><span class="line">        mBridges.add(bridge);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Use installer provided name for now; we always rename later</span></span><br><span class="line">        <span class="keyword">if</span> (!FileUtils.isValidExtFilename(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Invalid name: &quot;</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> File target;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">identity</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            target = <span class="keyword">new</span> <span class="title class_">File</span>(resolveStageDir(), name);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(identity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> this should delegate to DCS so the system process avoids</span></span><br><span class="line">        <span class="comment">// holding open FDs into containers.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">FileDescriptor</span> <span class="variable">targetFd</span> <span class="operator">=</span> Libcore.os.open(target.getAbsolutePath(),</span><br><span class="line">                O_CREAT | O_WRONLY, <span class="number">0644</span>);</span><br><span class="line">        Os.chmod(target.getAbsolutePath(), <span class="number">0644</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If caller specified a total length, allocate it for them. Free up</span></span><br><span class="line">        <span class="comment">// cache space to grow, if needed.</span></span><br><span class="line">        <span class="keyword">if</span> (lengthBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">StructStat</span> <span class="variable">stat</span> <span class="operator">=</span> Libcore.os.fstat(targetFd);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">deltaBytes</span> <span class="operator">=</span> lengthBytes - stat.st_size;</span><br><span class="line">            <span class="comment">// Only need to free up space when writing to internal stage</span></span><br><span class="line">            <span class="keyword">if</span> (stageDir != <span class="literal">null</span> &amp;&amp; deltaBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                mPm.freeStorage(params.volumeUuid, deltaBytes);</span><br><span class="line">            &#125;</span><br><span class="line">            Libcore.os.posix_fallocate(targetFd, <span class="number">0</span>, lengthBytes);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (offsetBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            Libcore.os.lseek(targetFd, offsetBytes, OsConstants.SEEK_SET);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        bridge.setTargetFile(targetFd);</span><br><span class="line">        bridge.start();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ParcelFileDescriptor</span>(bridge.getClientSocket());</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (ErrnoException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowAsIOException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FileBridge到底是什么呢，来看一下FileBridge类：</p>
<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/">core</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/">java</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/android/os/">os</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/android/os/FileBridge.java">FileBridge.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Simple bridge that allows file access across process boundaries without</span></span><br><span class="line"><span class="comment"> * returning the underlying &#123;<span class="doctag">@link</span> FileDescriptor&#125;. This is useful when the</span></span><br><span class="line"><span class="comment"> * server side needs to strongly assert that a client side is completely</span></span><br><span class="line"><span class="comment"> * hands-off.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileBridge</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;FileBridge&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> consider extending to support bidirectional IO</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MSG_LENGTH</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** CMD_WRITE [len] [data] */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CMD_WRITE</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">/** CMD_FSYNC */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CMD_FSYNC</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="comment">/** CMD_CLOSE */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CMD_CLOSE</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> FileDescriptor mTarget;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">FileDescriptor</span> <span class="variable">mServer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileDescriptor</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">FileDescriptor</span> <span class="variable">mClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileDescriptor</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> mClosed;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileBridge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 构造函数建立的mServer和mClient之间的管道</span></span><br><span class="line">            Os.socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, mServer, mClient);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ErrnoException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to create bridge&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isClosed</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mClosed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">forceClose</span><span class="params">()</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(mTarget);</span><br><span class="line">        IoUtils.closeQuietly(mServer);</span><br><span class="line">        IoUtils.closeQuietly(mClient);</span><br><span class="line">        mClosed = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTargetFile</span><span class="params">(FileDescriptor target)</span> &#123;</span><br><span class="line">        mTarget = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> FileDescriptor <span class="title function_">getClientSocket</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">byte</span>[] temp = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8192</span>];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// mServer和mClient已经通过管道绑定，取出从mClient写入到mServer中的数据并进行处理</span></span><br><span class="line">            <span class="keyword">while</span> (IoBridge.read(mServer, temp, <span class="number">0</span>, MSG_LENGTH) == MSG_LENGTH) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">cmd</span> <span class="operator">=</span> Memory.peekInt(temp, <span class="number">0</span>, ByteOrder.BIG_ENDIAN);</span><br><span class="line">                <span class="keyword">if</span> (cmd == CMD_WRITE) &#123;</span><br><span class="line">                    <span class="comment">// Shuttle data into local file</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> Memory.peekInt(temp, <span class="number">4</span>, ByteOrder.BIG_ENDIAN);</span><br><span class="line">                    <span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> IoBridge.read(mServer, temp, <span class="number">0</span>, Math.min(temp.length, len));</span><br><span class="line">                        <span class="keyword">if</span> (n == -<span class="number">1</span>) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(</span><br><span class="line">                                    <span class="string">&quot;Unexpected EOF; still expected &quot;</span> + len + <span class="string">&quot; bytes&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        IoBridge.write(mTarget, temp, <span class="number">0</span>, n);</span><br><span class="line">                        len -= n;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == CMD_FSYNC) &#123;</span><br><span class="line">                    <span class="comment">// Sync and echo back to confirm</span></span><br><span class="line">                    Os.fsync(mTarget);</span><br><span class="line">                    IoBridge.write(mServer, temp, <span class="number">0</span>, MSG_LENGTH);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == CMD_CLOSE) &#123;</span><br><span class="line">                    <span class="comment">// Close and echo back to confirm</span></span><br><span class="line">                    Os.fsync(mTarget);</span><br><span class="line">                    Os.close(mTarget);</span><br><span class="line">                    mClosed = <span class="literal">true</span>;</span><br><span class="line">                    IoBridge.write(mServer, temp, <span class="number">0</span>, MSG_LENGTH);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ErrnoException | IOException e) &#123;</span><br><span class="line">            Log.wtf(TAG, <span class="string">&quot;Failed during bridge&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            forceClose(); <span class="comment">// 此处会关闭bridge</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在PackageInstallerSession中的openWrite函数中，Pm得到与PackageInstallerSession通信的client端，同时PackageInstallerSession也启动了FileBridge准备接收数据。</p>
<p>在Write Session中进行文件copy时，最终是利用FileBridge的管道来完成实际的工作。</p>
<h4 id="3-3-Commit-Session"><a href="#3-3-Commit-Session" class="headerlink" title="3.3 Commit Session"></a>3.3 Commit Session</h4><p>在doWriteSession函数完成后，APK源文件已经copy到目的地址了，紧接着开始doCommitSession的工作：</p>
<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/">cmds</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/">src</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/">com</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/commands/">commands</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/commands/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/commands/pm/Pm.java">Pm.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">doCommitSession</span><span class="params">(<span class="type">int</span> sessionId, <span class="type">boolean</span> logSuccess)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    PackageInstaller.<span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        session = <span class="keyword">new</span> <span class="title class_">PackageInstaller</span>.Session(</span><br><span class="line">                mInstaller.openSession(sessionId));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">LocalIntentReceiver</span> <span class="variable">receiver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LocalIntentReceiver</span>();</span><br><span class="line">        <span class="comment">// 此处提交Session</span></span><br><span class="line">        session.commit(receiver.getIntentSender());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Intent</span> <span class="variable">result</span> <span class="operator">=</span> receiver.getResult();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> result.getIntExtra(PackageInstaller.EXTRA_STATUS,</span><br><span class="line">                PackageInstaller.STATUS_FAILURE);</span><br><span class="line">        <span class="keyword">if</span> (status == PackageInstaller.STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logSuccess) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Failure [&quot;</span></span><br><span class="line">                    + result.getStringExtra(PackageInstaller.EXTRA_STATUS_MESSAGE) + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(session);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/">core</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/">java</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/android/content/">content</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/android/content/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/android/content/pm/PackageInstaller.java">PackageInstaller.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Attempt to commit everything staged in this session. This may require</span></span><br><span class="line"><span class="comment"> * user intervention, and so it may not happen immediately. The final</span></span><br><span class="line"><span class="comment"> * result of the commit will be reported through the given callback.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Once this method is called, no additional mutations may be performed</span></span><br><span class="line"><span class="comment"> * on the session. If the device reboots before the session has been</span></span><br><span class="line"><span class="comment"> * finalized, you may commit the session again.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> SecurityException if streams opened through</span></span><br><span class="line"><span class="comment"> *             &#123;<span class="doctag">@link</span> #openWrite(String, long, long)&#125; are still open.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(<span class="meta">@NonNull</span> IntentSender statusReceiver)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 通过Binder通信调用PackageInstallerSession中的commit函数</span></span><br><span class="line">        mSession.commit(statusReceiver);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/">services</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/">core</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/">java</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/">com</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/">server</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/pm/PackageInstallerSession.java">PackageInstallerSession.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(IntentSender statusReceiver)</span> &#123;</span><br><span class="line">    Preconditions.checkNotNull(statusReceiver);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> wasSealed; <span class="comment">// boolean默认值为false</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        wasSealed = mSealed;</span><br><span class="line">        <span class="keyword">if</span> (!mSealed) &#123;</span><br><span class="line">            <span class="comment">// Verify that all writers are hands-off</span></span><br><span class="line">            <span class="comment">// 在FileBridge.java中run()的finally代码块中(也即doWriteSession传输数据的结尾)会关闭bridge</span></span><br><span class="line">            <span class="keyword">for</span> (FileBridge bridge : mBridges) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!bridge.isClosed()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Files still open&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            mSealed = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Client staging is fully done at this point</span></span><br><span class="line">        mClientProgress = <span class="number">1f</span>;</span><br><span class="line">        computeProgressLocked(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!wasSealed) &#123;</span><br><span class="line">        <span class="comment">// Persist the fact that we&#x27;ve sealed ourselves to prevent</span></span><br><span class="line">        <span class="comment">// mutations of any hard links we create. We do this without holding</span></span><br><span class="line">        <span class="comment">// the session lock, since otherwise it&#x27;s a lock inversion.</span></span><br><span class="line">        mCallback.onSessionSealedBlocking(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This ongoing commit should keep session active, even though client</span></span><br><span class="line">    <span class="comment">// will probably close their end.</span></span><br><span class="line">    mActiveCount.incrementAndGet();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">PackageInstallObserverAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageInstallObserverAdapter</span>(mContext,</span><br><span class="line">            statusReceiver, sessionId, mIsInstallerDeviceOwner, userId);</span><br><span class="line">    mHandler.obtainMessage(MSG_COMMIT, adapter.getBinder()).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>指定mHandler对应的callback：</p>
<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/">services</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/">core</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/">java</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/">com</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/">server</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/pm/PackageInstallerSession.java">PackageInstallerSession.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Handler.<span class="type">Callback</span> <span class="variable">mHandlerCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Handler</span>.Callback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        <span class="comment">// Cache package manager data without the lock held</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">PackageInfo</span> <span class="variable">pkgInfo</span> <span class="operator">=</span> mPm.getPackageInfo(</span><br><span class="line">                params.appPackageName, PackageManager.GET_SIGNATURES <span class="comment">/*flags*/</span>, userId);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ApplicationInfo</span> <span class="variable">appInfo</span> <span class="operator">=</span> mPm.getApplicationInfo(</span><br><span class="line">                params.appPackageName, <span class="number">0</span>, userId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (msg.obj != <span class="literal">null</span>) &#123;</span><br><span class="line">                mRemoteObserver = (IPackageInstallObserver2) msg.obj;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 最终触发commitLocked</span></span><br><span class="line">                commitLocked(pkgInfo, appInfo);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">completeMsg</span> <span class="operator">=</span> ExceptionUtils.getCompleteMessage(e);</span><br><span class="line">                Slog.e(TAG, <span class="string">&quot;Commit of session &quot;</span> + sessionId + <span class="string">&quot; failed: &quot;</span> + completeMsg);</span><br><span class="line">                destroyInternal();</span><br><span class="line">                dispatchSessionFinished(e.error, completeMsg, <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">commitLocked</span><span class="params">(PackageInfo pkgInfo, ApplicationInfo appInfo)</span></span><br><span class="line">        <span class="keyword">throws</span> PackageManagerException &#123;</span><br><span class="line">    ... ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        resolveStageDir(); <span class="comment">// 解析安装地址，即apk文件copy后的目的地址</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PackageManagerException</span>(INSTALL_FAILED_CONTAINER_ERROR,</span><br><span class="line">                <span class="string">&quot;Failed to resolve stage location&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Verify that stage looks sane with respect to existing application.</span></span><br><span class="line">    <span class="comment">// This currently only ensures packageName, versionCode, and certificate</span></span><br><span class="line">    <span class="comment">// consistency.</span></span><br><span class="line">    <span class="comment">// 检查apk文件是否满足要求，验证包名，版本号，证书的一致性</span></span><br><span class="line">    validateInstallLocked(pkgInfo, appInfo);</span><br><span class="line"></span><br><span class="line">    Preconditions.checkNotNull(mPackageName);</span><br><span class="line">    Preconditions.checkNotNull(mSignatures);</span><br><span class="line">    Preconditions.checkNotNull(mResolvedBaseFile);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查权限</span></span><br><span class="line">    <span class="keyword">if</span> (!mPermissionsAccepted) &#123;</span><br><span class="line">        <span class="comment">// User needs to accept permissions; give installer an intent they</span></span><br><span class="line">        <span class="comment">// can use to involve user.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(PackageInstaller.ACTION_CONFIRM_PERMISSIONS);</span><br><span class="line">        intent.setPackage(mContext.getPackageManager().getPermissionControllerPackageName());</span><br><span class="line">        intent.putExtra(PackageInstaller.EXTRA_SESSION_ID, sessionId);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mRemoteObserver.onUserActionRequired(intent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ignored) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Commit was keeping session marked as active until now; release</span></span><br><span class="line">        <span class="comment">// that extra refcount so session appears idle.</span></span><br><span class="line">        close();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stageCid != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Figure out the final installed size and resize the container once</span></span><br><span class="line">        <span class="comment">// and for all. Internally the parser handles straddling between two</span></span><br><span class="line">        <span class="comment">// locations when inheriting.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">finalSize</span> <span class="operator">=</span> calculateInstalledSize();</span><br><span class="line">        resizeContainer(stageCid, finalSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Inherit any packages and native libraries from existing install that</span></span><br><span class="line">    <span class="comment">// haven&#x27;t been overridden.</span></span><br><span class="line">    <span class="keyword">if</span> (params.mode == SessionParams.MODE_INHERIT_EXISTING) &#123;</span><br><span class="line">        <span class="comment">// 如果新的APK文件继承某些已安装的Package(不懂。。。)，此处将copy需要的native库文件等</span></span><br><span class="line">        ... ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> surface more granular state from dexopt</span></span><br><span class="line">    mInternalProgress = <span class="number">0.5f</span>;</span><br><span class="line">    computeProgressLocked(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Unpack native libraries</span></span><br><span class="line">    <span class="comment">// 解压native库文件</span></span><br><span class="line">    extractNativeLibraries(mResolvedStageDir, params.abiOverride);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Container is ready to go, let&#x27;s seal it up!</span></span><br><span class="line">    <span class="comment">// 封装容器，会针对安装在sdcard的操作做一些处理</span></span><br><span class="line">    <span class="keyword">if</span> (stageCid != <span class="literal">null</span>) &#123;</span><br><span class="line">        finalizeAndFixContainer(stageCid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We&#x27;ve reached point of no return; call into PMS to install the stage.</span></span><br><span class="line">    <span class="comment">// Regardless of success or failure we always destroy session.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">IPackageInstallObserver2</span> <span class="variable">localObserver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IPackageInstallObserver2</span>.Stub() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onUserActionRequired</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPackageInstalled</span><span class="params">(String basePackageName, <span class="type">int</span> returnCode, String msg,</span></span><br><span class="line"><span class="params">                Bundle extras)</span> &#123;</span><br><span class="line">            destroyInternal();</span><br><span class="line">            dispatchSessionFinished(returnCode, msg, extras);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> UserHandle user;</span><br><span class="line">    <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_ALL_USERS) != <span class="number">0</span>) &#123;</span><br><span class="line">        user = UserHandle.ALL;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        user = <span class="keyword">new</span> <span class="title class_">UserHandle</span>(userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mRelinquished = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// 调用PKMS的installStage，进入安装的下一步操作</span></span><br><span class="line">    mPm.installStage(mPackageName, stageDir, stageCid, localObserver, params,</span><br><span class="line">            installerPackageName, installerUid, user, mCertificates);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里可以总结Pm.java所做的事情，实际操作就是将adb copy的文件，copy到系统内或者sdcard的目录中，进行初步的权限检查等工作，最后通知PKMS进入Install Stage。这部分流程图如下：</p>
<p><img src="http://otqux1hnn.bkt.clouddn.com/rangerzhou/170904/pm.png" alt="pm流程"></p>
<h3 id="4-installStage"><a href="#4-installStage" class="headerlink" title="4. installStage"></a>4. installStage</h3><p>接下来进入PKMS，首先来看installStage函数：</p>
<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/">services</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/">core</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/">java</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/">com</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/">server</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java">PackageManagerService.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">installStage</span><span class="params">(String packageName, File stagedDir, String stagedCid,</span></span><br><span class="line"><span class="params">        IPackageInstallObserver2 observer, PackageInstaller.SessionParams sessionParams,</span></span><br><span class="line"><span class="params">        String installerPackageName, <span class="type">int</span> installerUid, UserHandle user,</span></span><br><span class="line"><span class="params">        Certificate[][] certificates)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_EPHEMERAL) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((sessionParams.installFlags &amp; PackageManager.INSTALL_EPHEMERAL) != <span class="number">0</span>) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">&quot;Ephemeral install of &quot;</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// verificationInfo主要用于存储权限验证需要的信息</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">VerificationInfo</span> <span class="variable">verificationInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VerificationInfo</span>(</span><br><span class="line">            sessionParams.originatingUri, sessionParams.referrerUri,</span><br><span class="line">            sessionParams.originatingUid, installerUid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> OriginInfo origin;</span><br><span class="line">    <span class="keyword">if</span> (stagedDir != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// origin存储apk文件的路径信息</span></span><br><span class="line">        origin = OriginInfo.fromStagedFile(stagedDir);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        origin = OriginInfo.fromStagedContainer(stagedCid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mHandler.obtainMessage(INIT_COPY); <span class="comment">// 参数为INIT_COPY</span></span><br><span class="line">    <span class="comment">// 准备安装所需要的参数</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">InstallParams</span> <span class="variable">params</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstallParams</span>(origin, <span class="literal">null</span>, observer,</span><br><span class="line">            sessionParams.installFlags, installerPackageName, sessionParams.volumeUuid,</span><br><span class="line">            verificationInfo, user, sessionParams.abiOverride,</span><br><span class="line">            sessionParams.grantedRuntimePermissions, certificates);</span><br><span class="line">    params.setTraceMethod(<span class="string">&quot;installStage&quot;</span>).setTraceCookie(System.identityHashCode(params));</span><br><span class="line">    msg.obj = params; <span class="comment">// 把安装参数赋给msg.obj</span></span><br><span class="line"></span><br><span class="line">    Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;installStage&quot;</span>,</span><br><span class="line">            System.identityHashCode(msg.obj));</span><br><span class="line">    Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;queueInstall&quot;</span>,</span><br><span class="line">            System.identityHashCode(msg.obj));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送INIT_COPY消息，驱动处理流程</span></span><br><span class="line">    mHandler.sendMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处的mHandler为PKMS中内部类PackageHandler对象，其中处理消息的函数为doHandleMessage:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_CONTAINER_PACKAGE</span> <span class="operator">=</span> <span class="string">&quot;com.android.defcontainer&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ComponentName</span> <span class="variable">DEFAULT_CONTAINER_COMPONENT</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComponentName</span>(</span><br><span class="line">            DEFAULT_CONTAINER_PACKAGE,</span><br><span class="line">            <span class="string">&quot;com.android.defcontainer.DefaultContainerService&quot;</span>);</span><br><span class="line">... ...</span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">PackageHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">mBound</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;HandlerParams&gt; mPendingInstalls =</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;HandlerParams&gt;();</span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">connectToService</span><span class="params">()</span> &#123; <span class="comment">// 其实就是bindService</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG, <span class="string">&quot;Trying to bind to&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; DefaultContainerService&quot;</span>);</span><br><span class="line">            <span class="comment">// 如上定义了component的包名和类名</span></span><br><span class="line">            <span class="type">Intent</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>().setComponent(DEFAULT_CONTAINER_COMPONENT);</span><br><span class="line">            Process.setThreadPriority(Process.THREAD_PRIORITY_DEFAULT);</span><br><span class="line">            <span class="keyword">if</span> (mContext.bindServiceAsUser(service, mDefContainerConn,</span><br><span class="line">                    Context.BIND_AUTO_CREATE, UserHandle.SYSTEM)) &#123;</span><br><span class="line">                Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">                mBound = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">disconnectService</span><span class="params">()</span> &#123; <span class="comment">// unbindService</span></span><br><span class="line">            mContainerService = <span class="literal">null</span>;</span><br><span class="line">            mBound = <span class="literal">false</span>;</span><br><span class="line">            Process.setThreadPriority(Process.THREAD_PRIORITY_DEFAULT);</span><br><span class="line">            mContext.unbindService(mDefContainerConn);</span><br><span class="line">            Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        PackageHandler(Looper looper) &#123;</span><br><span class="line">            <span class="built_in">super</span>(looper);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                doHandleMessage(msg);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">doHandleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">                <span class="keyword">case</span> INIT_COPY: &#123;</span><br><span class="line">                    <span class="comment">// 在installStage中msg.obj已经被赋值安装参数</span></span><br><span class="line">                    <span class="type">HandlerParams</span> <span class="variable">params</span> <span class="operator">=</span> (HandlerParams) msg.obj;</span><br><span class="line">                    <span class="comment">// idx为当前等待处理的安装请求个数</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> mPendingInstalls.size();</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">&quot;init_copy idx=&quot;</span> + idx + <span class="string">&quot;: &quot;</span> + params);</span><br><span class="line">                    <span class="comment">// If a bind was already initiated we dont really</span></span><br><span class="line">                    <span class="comment">// need to do anything. The pending install</span></span><br><span class="line">                    <span class="comment">// will be processed later on.</span></span><br><span class="line">                    <span class="comment">// 如果已经有一个绑定被初始化，那就不做任何事情，待安装的操作稍后会进行，初始时mBound的值为false</span></span><br><span class="line">                    <span class="keyword">if</span> (!mBound) &#123;</span><br><span class="line">                        Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;bindingMCS&quot;</span>,</span><br><span class="line">                                System.identityHashCode(mHandler));</span><br><span class="line">                        <span class="comment">// If this is the only one pending we might</span></span><br><span class="line">                        <span class="comment">// have to bind to the service again.</span></span><br><span class="line">                        <span class="comment">// 绑定实际的安装service</span></span><br><span class="line">                        <span class="keyword">if</span> (!connectToService()) &#123;</span><br><span class="line">                            Slog.e(TAG, <span class="string">&quot;Failed to bind to media container service&quot;</span>);</span><br><span class="line">                            params.serviceError();</span><br><span class="line">                            Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;bindingMCS&quot;</span>,</span><br><span class="line">                                    System.identityHashCode(mHandler));</span><br><span class="line">                            <span class="keyword">if</span> (params.traceMethod != <span class="literal">null</span>) &#123;</span><br><span class="line">                                Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, params.traceMethod,</span><br><span class="line">                                        params.traceCookie);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// Once we bind to the service, the first</span></span><br><span class="line">                            <span class="comment">// pending request will be processed.</span></span><br><span class="line">                            <span class="comment">// 绑定服务成功后，将请求加入到mPendingInstalls等待处理</span></span><br><span class="line">                            mPendingInstalls.add(idx, params);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 如果已经绑定过service，同样将新的请求加入到mPendingInstalls等待处理</span></span><br><span class="line">                        mPendingInstalls.add(idx, params);</span><br><span class="line">                        <span class="comment">// Already bound to the service. Just make</span></span><br><span class="line">                        <span class="comment">// sure we trigger off processing the first request.</span></span><br><span class="line">                        <span class="keyword">if</span> (idx == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// idx=0代表第一个请求，直接发送MCS_BOUND事件，触发处理流程</span></span><br><span class="line">                            mHandler.sendEmptyMessage(MCS_BOUND);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ... ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>PKMS定义了安装服务的包名<code>com.android.defcontainer</code>和类名<code>com.android.defcontainer.DefaultContainerService</code>，可知实际进行安装工作的是DefaultContainerService，还是定义在PKMS中，接下来看绑定服务成功后的操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DefaultContainerConnection</span> <span class="keyword">implements</span> <span class="title class_">ServiceConnection</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG, <span class="string">&quot;onServiceConnected&quot;</span>);</span><br><span class="line">        <span class="comment">// 获得与服务端通信的代理对象</span></span><br><span class="line">        <span class="type">IMediaContainerService</span> <span class="variable">imcs</span> <span class="operator">=</span></span><br><span class="line">            IMediaContainerService.Stub.asInterface(service);</span><br><span class="line">        <span class="comment">// 发送消息MCS_BOUND</span></span><br><span class="line">        mHandler.sendMessage(mHandler.obtainMessage(MCS_BOUND, imcs));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceDisconnected</span><span class="params">(ComponentName name)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG, <span class="string">&quot;onServiceDisconnected&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>绑定service后会获取与服务端通信的代理对象，并且发送MCS_BOUND消息，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">doHandleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        ... ...</span><br><span class="line">        <span class="keyword">case</span> MCS_BOUND: &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">&quot;mcs_bound&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (msg.obj != <span class="literal">null</span>) &#123;</span><br><span class="line">                mContainerService = (IMediaContainerService) msg.obj;</span><br><span class="line">                Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;bindingMCS&quot;</span>,</span><br><span class="line">                        System.identityHashCode(mHandler));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mContainerService == <span class="literal">null</span>) &#123;</span><br><span class="line">                ... ...</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingInstalls.size() &gt; <span class="number">0</span>) &#123; <span class="comment">// 安装请求的个数大于0</span></span><br><span class="line">                <span class="comment">// 获取第一个安装请求</span></span><br><span class="line">                <span class="type">HandlerParams</span> <span class="variable">params</span> <span class="operator">=</span> mPendingInstalls.get(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (params != <span class="literal">null</span>) &#123;</span><br><span class="line">                    Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;queueInstall&quot;</span>,</span><br><span class="line">                            System.identityHashCode(params));</span><br><span class="line">                    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;startCopy&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (params.startCopy()) &#123;</span><br><span class="line">                        <span class="comment">// We are done...  look for more work or to</span></span><br><span class="line">                        <span class="comment">// go idle.</span></span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG,</span><br><span class="line">                                <span class="string">&quot;Checking for more work or unbind...&quot;</span>);</span><br><span class="line">                        <span class="comment">// Delete pending install</span></span><br><span class="line">                        <span class="keyword">if</span> (mPendingInstalls.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            mPendingInstalls.remove(<span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (mPendingInstalls.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// 如果没有安装请求了则10秒钟后解绑service</span></span><br><span class="line">                            <span class="keyword">if</span> (mBound) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG,</span><br><span class="line">                                        <span class="string">&quot;Posting delayed MCS_UNBIND&quot;</span>);</span><br><span class="line">                                removeMessages(MCS_UNBIND);</span><br><span class="line">                                <span class="type">Message</span> <span class="variable">ubmsg</span> <span class="operator">=</span> obtainMessage(MCS_UNBIND);</span><br><span class="line">                                <span class="comment">// Unbind after a little delay, to avoid</span></span><br><span class="line">                                <span class="comment">// continual thrashing.</span></span><br><span class="line">                                sendMessageDelayed(ubmsg, <span class="number">10000</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// 否则继续发送MCS_BOUND消息</span></span><br><span class="line">                            <span class="comment">// There are more pending requests in queue.</span></span><br><span class="line">                            <span class="comment">// Just post MCS_BOUND message to trigger processing</span></span><br><span class="line">                            <span class="comment">// of next pending install.</span></span><br><span class="line">                            <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG,</span><br><span class="line">                                    <span class="string">&quot;Posting MCS_BOUND for next work&quot;</span>);</span><br><span class="line">                            mHandler.sendEmptyMessage(MCS_BOUND);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Should never happen ideally.</span></span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Empty queue&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>这段代码的功能就是处理安装请求，处理完后安装队列不为空，则继续发送MCS_BOUND消息继续处理下一个安装请求，如果安装队列为空，则等待10秒钟后发送MCS_UNBIND消息断开service绑定。</p>
<p>接下来看startCopy函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">HandlerParams</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_RETRIES</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">  ... ...</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">startCopy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> res;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">&quot;startCopy &quot;</span> + mUser + <span class="string">&quot;: &quot;</span> + <span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果最大安装重复次数大于4次，处理安装失败的消息</span></span><br><span class="line">            <span class="keyword">if</span> (++mRetries &gt; MAX_RETRIES) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Failed to invoke remote methods on default container service. Giving up&quot;</span>);</span><br><span class="line">                mHandler.sendEmptyMessage(MCS_GIVE_UP);</span><br><span class="line">                handleServiceError();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                handleStartCopy(); <span class="comment">// 实际的copy工作</span></span><br><span class="line">                res = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">&quot;Posting install MCS_RECONNECT&quot;</span>);</span><br><span class="line">            mHandler.sendEmptyMessage(MCS_RECONNECT);</span><br><span class="line">            res = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        handleReturnCode();</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="http://otqux1hnn.bkt.clouddn.com/rangerzhou/170728/installstage.png" alt="installStage"></p>
<h3 id="5-handleStartCopy"><a href="#5-handleStartCopy" class="headerlink" title="5. handleStartCopy"></a>5. handleStartCopy</h3><p>如上图，HandlerParams为内部抽象类，handleStartCopy在HandlerParams的子类InstallParams中实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">InstallParams</span> <span class="keyword">extends</span> <span class="title class_">HandlerParams</span> &#123;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Invoke remote method to get package information and install</span></span><br><span class="line"><span class="comment">     * location values. Override install location based on default</span></span><br><span class="line"><span class="comment">     * policy if needed and then create install arguments based</span></span><br><span class="line"><span class="comment">     * on the install location.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleStartCopy</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ret</span> <span class="operator">=</span> PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we&#x27;re already staged, we&#x27;ve firmly committed to an install location</span></span><br><span class="line">        <span class="keyword">if</span> (origin.staged) &#123;</span><br><span class="line">            <span class="keyword">if</span> (origin.file != <span class="literal">null</span>) &#123;</span><br><span class="line">                installFlags |= PackageManager.INSTALL_INTERNAL;</span><br><span class="line">                installFlags &amp;= ~PackageManager.INSTALL_EXTERNAL;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (origin.cid != <span class="literal">null</span>) &#123;</span><br><span class="line">                installFlags |= PackageManager.INSTALL_EXTERNAL;</span><br><span class="line">                installFlags &amp;= ~PackageManager.INSTALL_INTERNAL;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Invalid stage location&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">onSd</span> <span class="operator">=</span> (installFlags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">onInt</span> <span class="operator">=</span> (installFlags &amp; PackageManager.INSTALL_INTERNAL) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">ephemeral</span> <span class="operator">=</span> (installFlags &amp; PackageManager.INSTALL_EPHEMERAL) != <span class="number">0</span>;</span><br><span class="line">        <span class="type">PackageInfoLite</span> <span class="variable">pkgLite</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查APK的安装位置是否正确</span></span><br><span class="line">        <span class="keyword">if</span> (onInt &amp;&amp; onSd) &#123;</span><br><span class="line">            <span class="comment">// Check if both bits are set.</span></span><br><span class="line">            <span class="comment">// APK不能同时安装在内部存储和SD卡上</span></span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Conflicting flags specified for installing on both internal and external&quot;</span>);</span><br><span class="line">            ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (onSd &amp;&amp; ephemeral) &#123;</span><br><span class="line">            <span class="comment">// APK不能短暂的安装在SD卡中</span></span><br><span class="line">            Slog.w(TAG,  <span class="string">&quot;Conflicting flags specified for installing ephemeral on external&quot;</span>);</span><br><span class="line">            ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// getMini...用来解析安装包，返回PackageInfoLite对象，判断能否安装，具体见5.1</span></span><br><span class="line">            pkgLite = mContainerService.getMinimalPackageInfo(origin.resolvedPath, installFlags, packageAbiOverride);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_EPHEMERAL &amp;&amp; ephemeral) &#123;</span><br><span class="line">                Slog.v(TAG, <span class="string">&quot;pkgLite for install: &quot;</span> + pkgLite);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * If we have too little free space, try to free cache</span></span><br><span class="line"><span class="comment">             * before giving up.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="comment">// 如果由于存储空间过小导致安装失败时</span></span><br><span class="line">            <span class="keyword">if</span> (!origin.staged &amp;&amp; pkgLite.recommendedInstallLocation</span><br><span class="line">                    == PackageHelper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE) &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> focus freeing disk space on the target device</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">StorageManager</span> <span class="variable">storage</span> <span class="operator">=</span> StorageManager.from(mContext);</span><br><span class="line">                <span class="comment">// 获取设备内部存储空间允许的最小存储空间大小</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">long</span> <span class="variable">lowThreshold</span> <span class="operator">=</span> storage.getStorageLowBytes(</span><br><span class="line">                        Environment.getDataDirectory());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 计算安装APK大概所需的空间</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">long</span> <span class="variable">sizeBytes</span> <span class="operator">=</span> mContainerService.calculateInstalledSize(</span><br><span class="line">                        origin.resolvedPath, isForwardLocked(), packageAbiOverride);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 释放cache，尝试将缓存释放到大于等于sizeBytes + lowThreshold</span></span><br><span class="line">                    mInstaller.freeCache(<span class="literal">null</span>, sizeBytes + lowThreshold);</span><br><span class="line">                    <span class="comment">// 再次通过getMini...方法判断是否满足安装条件</span></span><br><span class="line">                    pkgLite = mContainerService.getMinimalPackageInfo(origin.resolvedPath,</span><br><span class="line">                            installFlags, packageAbiOverride);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">&quot;Failed to free cache&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * The cache free must have deleted the file we</span></span><br><span class="line"><span class="comment">                 * downloaded to install.</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 * <span class="doctag">TODO:</span> fix the &quot;freeCache&quot; call to not delete</span></span><br><span class="line"><span class="comment">                 *       the file we care about.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="comment">// 如果经过释放cache后还是无法安装，则把安装失败flag保存到recom...</span></span><br><span class="line">                <span class="keyword">if</span> (pkgLite.recommendedInstallLocation</span><br><span class="line">                        == PackageHelper.RECOMMEND_FAILED_INVALID_URI) &#123;</span><br><span class="line">                    pkgLite.recommendedInstallLocation</span><br><span class="line">                        = PackageHelper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ret == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">            <span class="comment">// recommendedInstallLocation保存安装路径信息，即内部还是SD卡中，也记录安装失败的信息</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">loc</span> <span class="operator">=</span> pkgLite.recommendedInstallLocation;</span><br><span class="line">            <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_INVALID_LOCATION) &#123;</span><br><span class="line">                ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_ALREADY_EXISTS) &#123;</span><br><span class="line">                ret = PackageManager.INSTALL_FAILED_ALREADY_EXISTS;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE) &#123;</span><br><span class="line">                ret = PackageManager.INSTALL_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_INVALID_APK) &#123;</span><br><span class="line">                ret = PackageManager.INSTALL_FAILED_INVALID_APK;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_INVALID_URI) &#123;</span><br><span class="line">                ret = PackageManager.INSTALL_FAILED_INVALID_URI;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_MEDIA_UNAVAILABLE) &#123;</span><br><span class="line">                ret = PackageManager.INSTALL_FAILED_MEDIA_UNAVAILABLE;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Override with defaults if needed.</span></span><br><span class="line">                <span class="comment">// 如果安装路径有足够的空间，loc就不会等于上述判断条件</span></span><br><span class="line">                <span class="comment">// 代码将会走到这里，installLocationPolicy用来判断APK是否已经安装过，具体见5.2</span></span><br><span class="line">                loc = installLocationPolicy(pkgLite);</span><br><span class="line">                ... ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建安装参数，具体见5.3</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">InstallArgs</span> <span class="variable">args</span> <span class="operator">=</span> createInstallArgs(<span class="built_in">this</span>);</span><br><span class="line">        mArgs = args;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ret == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> http://b/22976637</span></span><br><span class="line">            <span class="comment">// Apps installed for &quot;all&quot; users use the device owner to verify the app</span></span><br><span class="line">            <span class="type">UserHandle</span> <span class="variable">verifierUser</span> <span class="operator">=</span> getUser();</span><br><span class="line">            <span class="keyword">if</span> (verifierUser == UserHandle.ALL) &#123;</span><br><span class="line">                verifierUser = UserHandle.SYSTEM;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Determine if we have any installed package verifiers. If we</span></span><br><span class="line"><span class="comment">             * do, then we&#x27;ll defer to them to verify the packages.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">requiredUid</span> <span class="operator">=</span> mRequiredVerifierPackage == <span class="literal">null</span> ? -<span class="number">1</span></span><br><span class="line">                    : getPackageUid(mRequiredVerifierPackage, MATCH_DEBUG_TRIAGED_MISSING,</span><br><span class="line">                            verifierUser.getIdentifier());</span><br><span class="line">            <span class="keyword">if</span> (!origin.existing &amp;&amp; requiredUid != -<span class="number">1</span></span><br><span class="line">                    &amp;&amp; isVerificationEnabled(verifierUser.getIdentifier(), installFlags)) &#123;</span><br><span class="line">                <span class="comment">// 存在安装包检查者，并且满足启动检查条件，就利用安装包检查者检查</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">Intent</span> <span class="variable">verification</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(</span><br><span class="line">                        Intent.ACTION_PACKAGE_NEEDS_VERIFICATION);</span><br><span class="line">                verification.addFlags(Intent.FLAG_RECEIVER_FOREGROUND);</span><br><span class="line">                verification.setDataAndType(Uri.fromFile(<span class="keyword">new</span> <span class="title class_">File</span>(origin.resolvedPath)),</span><br><span class="line">                        PACKAGE_MIME_TYPE);</span><br><span class="line">                verification.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 检查安装包的操作</span></span><br><span class="line">                ... ...</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * No package verification is enabled, so immediately start</span></span><br><span class="line"><span class="comment">                 * the remote call to initiate copy using temporary file.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="comment">// 没有安装包检查，则直接执行copyApk函数，具体见5.4</span></span><br><span class="line">                ret = args.copyApk(mContainerService, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mRet = ret;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-1-getMinimalPackageInfo"><a href="#5-1-getMinimalPackageInfo" class="headerlink" title="5.1 getMinimalPackageInfo"></a>5.1 getMinimalPackageInfo</h4><p>getMinimalPackageInfo定义在DefaultContainerService中：</p>
<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/packages/">packages</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/packages/DefaultContainerService/">DefaultContainerService</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/packages/DefaultContainerService/src/">src</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/packages/DefaultContainerService/src/com/">com</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/packages/DefaultContainerService/src/com/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/packages/DefaultContainerService/src/com/android/defcontainer/">defcontainer</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/packages/DefaultContainerService/src/com/android/defcontainer/DefaultContainerService.java">DefaultContainerService.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Parse given package and return minimal details.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> packagePath absolute path to the package to be copied. Can be</span></span><br><span class="line"><span class="comment"> *            a single monolithic APK file or a cluster directory</span></span><br><span class="line"><span class="comment"> *            containing one or more APKs.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PackageInfoLite <span class="title function_">getMinimalPackageInfo</span><span class="params">(String packagePath, <span class="type">int</span> flags,</span></span><br><span class="line"><span class="params">        String abiOverride)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> DefaultContainerService.<span class="built_in">this</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isForwardLocked</span> <span class="operator">=</span> (flags &amp; PackageManager.INSTALL_FORWARD_LOCK) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">PackageInfoLite</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageInfoLite</span>();</span><br><span class="line">    <span class="keyword">if</span> (packagePath == <span class="literal">null</span>) &#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">&quot;Invalid package file &quot;</span> + packagePath);</span><br><span class="line">        ret.recommendedInstallLocation = PackageHelper.RECOMMEND_FAILED_INVALID_APK;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">File</span> <span class="variable">packageFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(packagePath);</span><br><span class="line">    <span class="keyword">final</span> PackageParser.PackageLite pkg;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> sizeBytes;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 解析安装包，得到PackageParser.PackageLite</span></span><br><span class="line">        pkg = PackageParser.parsePackageLite(packageFile, <span class="number">0</span>);</span><br><span class="line">        sizeBytes = PackageHelper.calculateInstalledSize(pkg, isForwardLocked, abiOverride);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageParserException | IOException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">&quot;Failed to parse package at &quot;</span> + packagePath + <span class="string">&quot;: &quot;</span> + e);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!packageFile.exists()) &#123;</span><br><span class="line">            ret.recommendedInstallLocation = PackageHelper.RECOMMEND_FAILED_INVALID_URI;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ret.recommendedInstallLocation = PackageHelper.RECOMMEND_FAILED_INVALID_APK;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret.packageName = pkg.packageName;</span><br><span class="line">    ret.splitNames = pkg.splitNames;</span><br><span class="line">    ret.versionCode = pkg.versionCode;</span><br><span class="line">    ret.baseRevisionCode = pkg.baseRevisionCode;</span><br><span class="line">    ret.splitRevisionCodes = pkg.splitRevisionCodes;</span><br><span class="line">    ret.installLocation = pkg.installLocation;</span><br><span class="line">    ret.verifiers = pkg.verifiers;</span><br><span class="line">    <span class="comment">// 利用resolveInstallLocation获取安装位置</span></span><br><span class="line">    ret.recommendedInstallLocation = PackageHelper.resolveInstallLocation(context,</span><br><span class="line">            pkg.packageName, pkg.installLocation, sizeBytes, flags);</span><br><span class="line">    ret.multiArch = pkg.multiArch;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从代码可知<code>getMinimalPackageInfo</code>就是对安装包进行解析，获取安装包的一些信息。</p>
<p>resolveInstallLocation:</p>
<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/">core</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/">java</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/com/">com</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/com/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/com/android/internal/">internal</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/com/android/internal/content/">content</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/core/java/com/android/internal/content/PackageHelper.java">PackageHelper.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Given a requested &#123;<span class="doctag">@link</span> PackageInfo#installLocation&#125; and calculated</span></span><br><span class="line"><span class="comment"> * install size, pick the actual location to install the app.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">resolveInstallLocation</span><span class="params">(Context context, String packageName,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> installLocation, <span class="type">long</span> sizeBytes, <span class="type">int</span> installFlags)</span> &#123;</span><br><span class="line">    <span class="type">ApplicationInfo</span> <span class="variable">existingInfo</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 就根据包名获取已经存在的ApplicationInfo信息，意如其名existingInfo</span></span><br><span class="line">        existingInfo = context.getPackageManager().getApplicationInfo(packageName,</span><br><span class="line">                PackageManager.GET_UNINSTALLED_PACKAGES);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NameNotFoundException ignored) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> prefer;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> checkBoth;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">ephemeral</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// 根据installFlags与一些常量flag参数的相与结果以及installLocation决定安装路径</span></span><br><span class="line">    <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_EPHEMERAL) != <span class="number">0</span>) &#123;</span><br><span class="line">        prefer = RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">        ephemeral = <span class="literal">true</span>;</span><br><span class="line">        checkBoth = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_INTERNAL) != <span class="number">0</span>) &#123;</span><br><span class="line">        prefer = RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">        checkBoth = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>) &#123;</span><br><span class="line">        prefer = RECOMMEND_INSTALL_EXTERNAL;</span><br><span class="line">        checkBoth = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installLocation == PackageInfo.INSTALL_LOCATION_INTERNAL_ONLY) &#123;</span><br><span class="line">        prefer = RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">        checkBoth = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installLocation == PackageInfo.INSTALL_LOCATION_PREFER_EXTERNAL) &#123;</span><br><span class="line">        prefer = RECOMMEND_INSTALL_EXTERNAL;</span><br><span class="line">        checkBoth = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installLocation == PackageInfo.INSTALL_LOCATION_AUTO) &#123;</span><br><span class="line">        <span class="comment">// 一般情况下installLocation为AUTO</span></span><br><span class="line">        <span class="comment">// When app is already installed, prefer same medium</span></span><br><span class="line">        <span class="keyword">if</span> (existingInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> distinguish if this is external ASEC</span></span><br><span class="line">            <span class="comment">// APK以前安装过，直接从保存的ApplicationInfo中获取flag得出安装路径</span></span><br><span class="line">            <span class="keyword">if</span> ((existingInfo.flags &amp; ApplicationInfo.FLAG_EXTERNAL_STORAGE) != <span class="number">0</span>) &#123;</span><br><span class="line">                prefer = RECOMMEND_INSTALL_EXTERNAL;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                prefer = RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果existingInfo为null，即以前没有安装过，则安装在手机内部</span></span><br><span class="line">            prefer = RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">        &#125;</span><br><span class="line">        checkBoth = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 默认情况下也安装在手机内部</span></span><br><span class="line">        prefer = RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">        checkBoth = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fitsOnInternal函数会判断上文中得出的sizeBytes是否小于data目录的剩余空间</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">fitsOnInternal</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (checkBoth || prefer == RECOMMEND_INSTALL_INTERNAL) &#123;</span><br><span class="line">        fitsOnInternal = fitsOnInternal(context, sizeBytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fitsOnExternal和fitsOnInternal一样都是判断是否有足够空间安装</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">fitsOnExternal</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (checkBoth || prefer == RECOMMEND_INSTALL_EXTERNAL) &#123;</span><br><span class="line">        fitsOnExternal = fitsOnExternal(context, sizeBytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据prefer和上面得出的fits...再次判断返回的安装目录</span></span><br><span class="line">    <span class="comment">// 怎么这么多重复判断呢，感觉代码写的有点冗余，明明可以合在上面代码中一并处理</span></span><br><span class="line">    <span class="keyword">if</span> (prefer == RECOMMEND_INSTALL_INTERNAL) &#123;</span><br><span class="line">        <span class="comment">// The ephemeral case will either fit and return EPHEMERAL, or will not fit</span></span><br><span class="line">        <span class="comment">// and will fall through to return INSUFFICIENT_STORAGE</span></span><br><span class="line">        <span class="keyword">if</span> (fitsOnInternal) &#123;</span><br><span class="line">            <span class="keyword">return</span> (ephemeral)</span><br><span class="line">                    ? PackageHelper.RECOMMEND_INSTALL_EPHEMERAL</span><br><span class="line">                    : PackageHelper.RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prefer == RECOMMEND_INSTALL_EXTERNAL) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fitsOnExternal) &#123;</span><br><span class="line">            <span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_EXTERNAL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 正常情况下以上部分代码已经返回了安装路径</span></span><br><span class="line">    <span class="keyword">if</span> (checkBoth) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fitsOnInternal) &#123;</span><br><span class="line">            <span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fitsOnExternal) &#123;</span><br><span class="line">            <span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_EXTERNAL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果没有足够的空间安装，则返回。。。</span></span><br><span class="line">    <span class="keyword">return</span> PackageHelper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>resolveInstallLocation</code>的作用就是判断安装路径是否有足够的工具，返回对应的flag。</p>
<h4 id="5-2-installLocationPolicy"><a href="#5-2-installLocationPolicy" class="headerlink" title="5.2 installLocationPolicy"></a>5.2 installLocationPolicy</h4><p>如果<code>resolveInstallLocation</code>返回的不是FAILED的flag，就会调用installLocationPolicy函数判断APK是否安装过，返回安装路径：</p>
<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/">services</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/">core</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/">java</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/">com</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/">server</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java">PackageManagerService.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">InstallParams</span> <span class="keyword">extends</span> <span class="title class_">HandlerParams</span> &#123;</span><br><span class="line">  ... ...</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">installLocationPolicy</span><span class="params">(PackageInfoLite pkgLite)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> pkgLite.packageName;</span><br><span class="line">        <span class="type">int</span> <span class="variable">installLocation</span> <span class="operator">=</span> pkgLite.installLocation;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">onSd</span> <span class="operator">=</span> (installFlags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// reader</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="comment">// Currently installed package which the new package is attempting to replace or</span></span><br><span class="line">            <span class="comment">// null if no such package is installed.</span></span><br><span class="line">            <span class="comment">// 判断终端上是否安装过同样的APK</span></span><br><span class="line">            PackageParser.<span class="type">Package</span> <span class="variable">installedPkg</span> <span class="operator">=</span> mPackages.get(packageName);</span><br><span class="line">            <span class="comment">// ... ...</span></span><br><span class="line">            <span class="comment">// 如果installedPkg为null，则APK已卸载</span></span><br><span class="line">            PackageParser.<span class="type">Package</span> <span class="variable">dataOwnerPkg</span> <span class="operator">=</span> installedPkg;</span><br><span class="line">            <span class="keyword">if</span> (dataOwnerPkg  == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果APK卸载了，但是保留了数据，那么将取出对应的PackageSetting对象</span></span><br><span class="line">                <span class="type">PackageSetting</span> <span class="variable">ps</span> <span class="operator">=</span> mSettings.mPackages.get(packageName);</span><br><span class="line">                <span class="keyword">if</span> (ps != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 如果取出的PackageSetting不为空，则取出对应的pkg给dataOwnerPkg</span></span><br><span class="line">                    dataOwnerPkg = ps.pkg;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 存在旧APK的信息</span></span><br><span class="line">            <span class="keyword">if</span> (dataOwnerPkg != <span class="literal">null</span>) &#123;</span><br><span class="line">	<span class="comment">// 只有当不是降级版本时，或者前身程序包被标记为可调式且显示请求降级时，才允许新的程序包有访问前身保留数据的权限</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">downgradeRequested</span> <span class="operator">=</span></span><br><span class="line">                        (installFlags &amp; PackageManager.INSTALL_ALLOW_DOWNGRADE) != <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">packageDebuggable</span> <span class="operator">=</span></span><br><span class="line">                            (dataOwnerPkg.applicationInfo.flags</span><br><span class="line">                                    &amp; ApplicationInfo.FLAG_DEBUGGABLE) != <span class="number">0</span>;</span><br><span class="line">                <span class="comment">// 降级安装的情况,不会在下面比较版本号</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">downgradePermitted</span> <span class="operator">=</span></span><br><span class="line">                        (downgradeRequested) &amp;&amp; ((Build.IS_DEBUGGABLE) || (packageDebuggable));</span><br><span class="line">                <span class="comment">// 正常情况下，即非降级安装时，会比较两个package信息中的versionCode</span></span><br><span class="line">                <span class="keyword">if</span> (!downgradePermitted) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        checkDowngrade(dataOwnerPkg, pkgLite);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">&quot;Downgrade detected: &quot;</span> + e.getMessage());</span><br><span class="line">                        <span class="keyword">return</span> PackageHelper.RECOMMEND_FAILED_VERSION_DOWNGRADE;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// installedPkg不为空，则表示旧的APK还在终端上没卸载</span></span><br><span class="line">            <span class="keyword">if</span> (installedPkg != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_REPLACE_EXISTING) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// Check for updated system application.</span></span><br><span class="line">                    <span class="keyword">if</span> ((installedPkg.applicationInfo.flags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// 系统app不能在SD卡上安装更新</span></span><br><span class="line">                        <span class="keyword">if</span> (onSd) &#123;</span><br><span class="line">                            Slog.w(TAG, <span class="string">&quot;Cannot install update to system app on sdcard&quot;</span>);</span><br><span class="line">                            <span class="keyword">return</span> PackageHelper.RECOMMEND_FAILED_INVALID_LOCATION;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (onSd) &#123;</span><br><span class="line">                            <span class="comment">// Install flag overrides everything.</span></span><br><span class="line">                            <span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_EXTERNAL;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// If current upgrade specifies particular preference</span></span><br><span class="line">                        <span class="keyword">if</span> (installLocation == PackageInfo.INSTALL_LOCATION_INTERNAL_ONLY) &#123;</span><br><span class="line">                            <span class="comment">// Application explicitly specified internal.</span></span><br><span class="line">                            <span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installLocation == PackageInfo.INSTALL_LOCATION_PREFER_EXTERNAL) &#123;</span><br><span class="line">                            <span class="comment">// App explictly prefers external. Let policy decide</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// Prefer previous location</span></span><br><span class="line">                            <span class="comment">// 如果没有指定安装路径，与之前的安装路径保持一致</span></span><br><span class="line">                            <span class="keyword">if</span> (isExternal(installedPkg)) &#123;</span><br><span class="line">                                <span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_EXTERNAL;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Invalid install. Return error code</span></span><br><span class="line">                    <span class="keyword">return</span> PackageHelper.RECOMMEND_FAILED_ALREADY_EXISTS;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// All the special cases have been taken care of.</span></span><br><span class="line">        <span class="comment">// Return result based on recommended install location.</span></span><br><span class="line">        <span class="keyword">if</span> (onSd) &#123;</span><br><span class="line">            <span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_EXTERNAL;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pkgLite.recommendedInstallLocation;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>从代码可知，installLocationPolicy函数就是判断APK是否安装过，对于升级安装要比较新旧两个package的版本号，再根据一些参数最后返回安装路径。</p>
<h4 id="5-3-createInstallArgs"><a href="#5-3-createInstallArgs" class="headerlink" title="5.3 createInstallArgs"></a>5.3 createInstallArgs</h4><p>随后PKMS开始调用createInstallArgs方法生成安装参数对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> InstallArgs <span class="title function_">createInstallArgs</span><span class="params">(InstallParams params)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (params.move != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MoveInstallArgs</span>(params);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installOnExternalAsec(params.installFlags) || params.isForwardLocked()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AsecInstallArgs</span>(params);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FileInstallArgs</span>(params);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据params决定创建哪个InstallArgs的子类对象，在这里将会创建FileInstallArgs对象。</p>
<h4 id="5-4-copyApk"><a href="#5-4-copyApk" class="headerlink" title="5.4 copyApk"></a>5.4 copyApk</h4><p>在handleStartCopy中创建安装参数后，如果不需要进行安装包检查，则调用上一步创建的安装参数FileInstallArgs的copyApk方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Logic to handle installation of non-ASEC applications, including copying</span></span><br><span class="line"><span class="comment"> * and renaming logic.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileInstallArgs</span> <span class="keyword">extends</span> <span class="title class_">InstallArgs</span> &#123;</span><br><span class="line">  ... ...</span><br><span class="line">    <span class="type">int</span> <span class="title function_">copyApk</span><span class="params">(IMediaContainerService imcs, <span class="type">boolean</span> temp)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;copyApk&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> doCopyApk(imcs, temp);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">doCopyApk</span><span class="params">(IMediaContainerService imcs, <span class="type">boolean</span> temp)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="comment">// Android 7.0对于adb安装在前文3.2 WriteSession中已经完成了copy操作，在installStag函数</span></span><br><span class="line">        <span class="comment">// 中调用的OriginInfo.fromStagedFile和OriginInfo.fromStagedContainer两个方法均会把</span></span><br><span class="line">        <span class="comment">// origin.staged设置为true</span></span><br><span class="line">        <span class="keyword">if</span> (origin.staged) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, origin.file + <span class="string">&quot; already staged; skipping copy&quot;</span>);</span><br><span class="line">            codeFile = origin.file;</span><br><span class="line">            resourceFile = origin.file;</span><br><span class="line">            <span class="keyword">return</span> PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对于非adb安装</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 临时安装flag</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isEphemeral</span> <span class="operator">=</span> (installFlags &amp; PackageManager.INSTALL_EPHEMERAL) != <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 创建一个临时安装的目录</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">File</span> <span class="variable">tempDir</span> <span class="operator">=</span></span><br><span class="line">                    mInstallerService.allocateStageDirLegacy(volumeUuid, isEphemeral);</span><br><span class="line">            codeFile = tempDir;</span><br><span class="line">            resourceFile = tempDir;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Failed to create copy file: &quot;</span> + e);</span><br><span class="line">            <span class="keyword">return</span> PackageManager.INSTALL_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义一个回调接口</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">IParcelFileDescriptorFactory</span> <span class="variable">target</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IParcelFileDescriptorFactory</span>.Stub() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> ParcelFileDescriptor <span class="title function_">open</span><span class="params">(String name, <span class="type">int</span> mode)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">                <span class="keyword">if</span> (!FileUtils.isValidExtFilename(name)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Invalid filename: &quot;</span> + name);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 接口被回调时的操作，包含创建文件，打开文件，返回ParcelFileDescriptor对象</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(codeFile, name);</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">FileDescriptor</span> <span class="variable">fd</span> <span class="operator">=</span> Os.open(file.getAbsolutePath(),</span><br><span class="line">                            O_RDWR | O_CREAT, <span class="number">0644</span>);</span><br><span class="line">                    Os.chmod(file.getAbsolutePath(), <span class="number">0644</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ParcelFileDescriptor</span>(fd);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ErrnoException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RemoteException</span>(<span class="string">&quot;Failed to open: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">ret</span> <span class="operator">=</span> PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">        <span class="comment">// 通过DefaultContainerService的copyPackage方法进行copy，target是上面的回调的接口</span></span><br><span class="line">        ret = imcs.copyPackage(origin.file.getAbsolutePath(), target);</span><br><span class="line">        <span class="keyword">if</span> (ret != PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">&quot;Failed to copy package&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// copy APK对应的Native库文件</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">File</span> <span class="variable">libraryRoot</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(codeFile, LIB_DIR_NAME);</span><br><span class="line">        NativeLibraryHelper.<span class="type">Handle</span> <span class="variable">handle</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            handle = NativeLibraryHelper.Handle.create(codeFile);</span><br><span class="line">            ret = NativeLibraryHelper.copyNativeBinariesWithOverride(handle, libraryRoot,</span><br><span class="line">                    abiOverride);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">&quot;Copying native libraries failed&quot;</span>, e);</span><br><span class="line">            ret = PackageManager.INSTALL_FAILED_INTERNAL_ERROR;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IoUtils.closeQuietly(handle);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>看一下DefaultContainerService的copyPackage操作：</p>
<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/packages/">packages</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/packages/DefaultContainerService/">DefaultContainerService</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/packages/DefaultContainerService/src/">src</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/packages/DefaultContainerService/src/com/">com</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/packages/DefaultContainerService/src/com/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/packages/DefaultContainerService/src/com/android/defcontainer/">defcontainer</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/packages/DefaultContainerService/src/com/android/defcontainer/DefaultContainerService.java">DefaultContainerService.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Copy package to the target location.</span></span><br><span class="line"><span class="comment">         * copy安装包到target</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> packagePath absolute path to the package to be copied. Can be</span></span><br><span class="line"><span class="comment">         *            a single monolithic APK file or a cluster directory</span></span><br><span class="line"><span class="comment">         *            containing one or more APKs.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> returns status code according to those in</span></span><br><span class="line"><span class="comment">         *         &#123;<span class="doctag">@link</span> PackageManager&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">copyPackage</span><span class="params">(String packagePath, IParcelFileDescriptorFactory target)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (packagePath == <span class="literal">null</span> || target == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> PackageManager.INSTALL_FAILED_INVALID_URI;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">PackageLite</span> <span class="variable">pkg</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">File</span> <span class="variable">packageFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(packagePath);</span><br><span class="line">                pkg = PackageParser.parsePackageLite(packageFile, <span class="number">0</span>); <span class="comment">// 解析packageFile</span></span><br><span class="line">                <span class="keyword">return</span> copyPackageInner(pkg, target); <span class="comment">// 调用copyPackageInner</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageParserException | IOException | RemoteException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Failed to copy package at &quot;</span> + packagePath + <span class="string">&quot;: &quot;</span> + e);</span><br><span class="line">                <span class="keyword">return</span> PackageManager.INSTALL_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">... ...</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">copyPackageInner</span><span class="params">(PackageLite pkg, IParcelFileDescriptorFactory target)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, RemoteException &#123;</span><br><span class="line">        copyFile(pkg.baseCodePath, target, <span class="string">&quot;base.apk&quot;</span>); <span class="comment">// 实际copy的执行</span></span><br><span class="line">  		<span class="comment">// 处理多apk的情况</span></span><br><span class="line">        <span class="keyword">if</span> (!ArrayUtils.isEmpty(pkg.splitNames)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; pkg.splitNames.length; i++) &#123;</span><br><span class="line">                copyFile(pkg.splitCodePaths[i], target, <span class="string">&quot;split_&quot;</span> + pkg.splitNames[i] + <span class="string">&quot;.apk&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">copyFile</span><span class="params">(String sourcePath, IParcelFileDescriptorFactory target, String targetName)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, RemoteException &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">&quot;Copying &quot;</span> + sourcePath + <span class="string">&quot; to &quot;</span> + targetName);</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            in = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(sourcePath); <span class="comment">// 输入源</span></span><br><span class="line">            <span class="comment">// 输出源，在doCopyApk中定义的回调接口的open函数，会创建文件，打开文件，</span></span><br><span class="line">            <span class="comment">// 赋予权限，返回ParcelFileDescriptor对象</span></span><br><span class="line">            out = <span class="keyword">new</span> <span class="title class_">ParcelFileDescriptor</span>.AutoCloseOutputStream(</span><br><span class="line">                    target.open(targetName, ParcelFileDescriptor.MODE_READ_WRITE));</span><br><span class="line">            Streams.copy(in, out); <span class="comment">// 执行copy操作</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 关闭输入输出流</span></span><br><span class="line">            IoUtils.closeQuietly(out);</span><br><span class="line">            IoUtils.closeQuietly(in);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>对于非adb安装路径，handleStartCopy会进行copy的操作，对于adb安装途经则并没有做什么实质性的操作，整个handleStartCopy的流程如下：</p>
<p><img src="http://otqux1hnn.bkt.clouddn.com/rangerzhou/170728/handleStartCopy.png" alt="handleStartCopy"></p>
<h3 id="6-handleReturnCode"><a href="#6-handleReturnCode" class="headerlink" title="6. handleReturnCode"></a>6. handleReturnCode</h3><p>在handleStartCopy后，会调用handleReturnCode：</p>
<p>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/">frameworks</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/">base</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/">services</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/">core</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/">java</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/">com</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/">android</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/">server</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/pm/">pm</a>&#x2F;<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java">PackageManagerService.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">InstallParams</span> <span class="keyword">extends</span> <span class="title class_">HandlerParams</span> &#123;</span><br><span class="line">  ... ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">handleReturnCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mArgs != <span class="literal">null</span>) &#123;</span><br><span class="line">            processPendingInstall(mArgs, mRet);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ... ...</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processPendingInstall</span><span class="params">(<span class="keyword">final</span> InstallArgs args, <span class="keyword">final</span> <span class="type">int</span> currentStatus)</span> &#123;</span><br><span class="line">    <span class="comment">// Queue up an async operation since the package installation may take a little while.</span></span><br><span class="line">    <span class="comment">// 安装需要一些时间，新建一个线程</span></span><br><span class="line">    mHandler.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            mHandler.removeCallbacks(<span class="built_in">this</span>);</span><br><span class="line">             <span class="comment">// Result object to be returned</span></span><br><span class="line">            <span class="type">PackageInstalledInfo</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageInstalledInfo</span>();</span><br><span class="line">            res.setReturnCode(currentStatus);</span><br><span class="line">            res.uid = -<span class="number">1</span>;</span><br><span class="line">            res.pkg = <span class="literal">null</span>;</span><br><span class="line">            res.removedInfo = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                <span class="comment">// 见6.1</span></span><br><span class="line">                args.doPreInstall(res.returnCode);</span><br><span class="line">                <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                    <span class="comment">// 进行安装，见6.2</span></span><br><span class="line">                    installPackageTracedLI(args, res);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 见6.3</span></span><br><span class="line">                args.doPostInstall(res.returnCode, res.uid);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// A restore should be performed at this point if (a) the install</span></span><br><span class="line">            <span class="comment">// succeeded, (b) the operation is not an update, and (c) the new</span></span><br><span class="line">            <span class="comment">// package has not opted out of backup participation.</span></span><br><span class="line">            <span class="comment">// 如果(a)安装成功(b)不是更新操作(c)新的package没有选择退出备份，则进行备份</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">update</span> <span class="operator">=</span> res.removedInfo != <span class="literal">null</span></span><br><span class="line">                    &amp;&amp; res.removedInfo.removedPackage != <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">flags</span> <span class="operator">=</span> (res.pkg == <span class="literal">null</span>) ? <span class="number">0</span> : res.pkg.applicationInfo.flags;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">doRestore</span> <span class="operator">=</span> !update</span><br><span class="line">                    &amp;&amp; ((flags &amp; ApplicationInfo.FLAG_ALLOW_BACKUP) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set up the post-install work request bookkeeping.  This will be used</span></span><br><span class="line">            <span class="comment">// and cleaned up by the post-install event handling regardless of whether</span></span><br><span class="line">            <span class="comment">// there&#x27;s a restore pass performed.  Token values are &gt;= 1.</span></span><br><span class="line">            <span class="type">int</span> token;</span><br><span class="line">            <span class="keyword">if</span> (mNextInstallToken &lt; <span class="number">0</span>) mNextInstallToken = <span class="number">1</span>;</span><br><span class="line">            token = mNextInstallToken++;</span><br><span class="line"></span><br><span class="line">            <span class="type">PostInstallData</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PostInstallData</span>(args, res);</span><br><span class="line">            mRunningInstalls.put(token, data);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_INSTALL) Log.v(TAG, <span class="string">&quot;+ starting restore round-trip &quot;</span> + token);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// doRestore为true的话则进行恢复工作</span></span><br><span class="line">            <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED &amp;&amp; doRestore) &#123;</span><br><span class="line">                <span class="comment">// Pass responsibility to the Backup Manager.  It will perform a</span></span><br><span class="line">                <span class="comment">// restore if appropriate, then pass responsibility back to the</span></span><br><span class="line">                <span class="comment">// Package Manager to run the post-install observer callbacks</span></span><br><span class="line">                <span class="comment">// and broadcasts.</span></span><br><span class="line">                <span class="type">IBackupManager</span> <span class="variable">bm</span> <span class="operator">=</span> IBackupManager.Stub.asInterface(</span><br><span class="line">                        ServiceManager.getService(Context.BACKUP_SERVICE));</span><br><span class="line">                <span class="keyword">if</span> (bm != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_INSTALL) Log.v(TAG, <span class="string">&quot;token &quot;</span> + token</span><br><span class="line">                            + <span class="string">&quot; to BM for possible restore&quot;</span>);</span><br><span class="line">                    Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;restore&quot;</span>, token);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// <span class="doctag">TODO:</span> http://b/22388012</span></span><br><span class="line">                        <span class="keyword">if</span> (bm.isBackupServiceActive(UserHandle.USER_SYSTEM)) &#123;</span><br><span class="line">                            bm.restoreAtInstall(res.pkg.applicationInfo.packageName, token);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            doRestore = <span class="literal">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                        <span class="comment">// can&#x27;t happen; the backup manager is local</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        Slog.e(TAG, <span class="string">&quot;Exception trying to enqueue restore&quot;</span>, e);</span><br><span class="line">                        doRestore = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.e(TAG, <span class="string">&quot;Backup Manager not found!&quot;</span>);</span><br><span class="line">                    doRestore = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!doRestore) &#123;</span><br><span class="line">                <span class="comment">// No restore possible, or the Backup Manager was mysteriously not</span></span><br><span class="line">                <span class="comment">// available -- just fire the post-install work request directly.</span></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_INSTALL) Log.v(TAG, <span class="string">&quot;No restore - queue post-install for &quot;</span> + token);</span><br><span class="line"></span><br><span class="line">                Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;postInstall&quot;</span>, token);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 发送POST_INSTALL消息，见6.4</span></span><br><span class="line">                <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mHandler.obtainMessage(POST_INSTALL, token, <span class="number">0</span>);</span><br><span class="line">                mHandler.sendMessage(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="6-1-doPreInstall"><a href="#6-1-doPreInstall" class="headerlink" title="6.1 doPreInstall"></a>6.1 doPreInstall</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FileInstallArgs</span> <span class="keyword">extends</span> <span class="title class_">InstallArgs</span> &#123;</span><br><span class="line">  ... ...</span><br><span class="line">    <span class="type">int</span> <span class="title function_">doPreInstall</span><span class="params">(<span class="type">int</span> status)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (status != PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">            cleanUp();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">  ... ...</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">cleanUp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (codeFile == <span class="literal">null</span> || !codeFile.exists()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        removeCodePathLI(codeFile);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (resourceFile != <span class="literal">null</span> &amp;&amp; !FileUtils.contains(codeFile, resourceFile)) &#123;</span><br><span class="line">            resourceFile.delete();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在前面代码调用doPreInstall之前已经判断了status是否等于PackageManager.INSTALL_SUCCEEDED，传入的参数也是PackageManager.INSTALL_SUCCEEDED，所以根本就没做什么操作，直接把status返回了，看其他调用doPreInstall的地方也是传入的XXX_SUCCEEDED，莫名其妙。。。</p>
<h4 id="6-2-installPackageTracedLI"><a href="#6-2-installPackageTracedLI" class="headerlink" title="6.2 installPackageTracedLI"></a>6.2 installPackageTracedLI</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">installPackageTracedLI</span><span class="params">(InstallArgs args, PackageInstalledInfo res)</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;installPackage&quot;</span>);</span><br><span class="line">          installPackageLI(args, res);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">installPackageLI</span><span class="params">(InstallArgs args, PackageInstalledInfo res)</span> &#123;</span><br><span class="line">      ... ...</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Result object to be returned</span></span><br><span class="line">      res.setReturnCode(PackageManager.INSTALL_SUCCEEDED);</span><br><span class="line"></span><br><span class="line">      ... ...</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Retrieve PackageSettings and parse package</span></span><br><span class="line">      <span class="keyword">final</span> <span class="type">int</span> <span class="variable">parseFlags</span> <span class="operator">=</span> mDefParseFlags | ...;</span><br><span class="line">      <span class="type">PackageParser</span> <span class="variable">pp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageParser</span>();</span><br><span class="line">      pp.setSeparateProcesses(mSeparateProcesses);</span><br><span class="line">      pp.setDisplayMetrics(mMetrics);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> PackageParser.Package pkg;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 解析APK文件得到PackageParser.Package对象</span></span><br><span class="line">          pkg = pp.parsePackage(tmpPackageFile, parseFlags);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">          res.setError(<span class="string">&quot;Failed parse during installPackageLI&quot;</span>, e);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If we are installing a clustered package add results for the children</span></span><br><span class="line">      <span class="comment">// 安装clustered pacakge时的一些操作</span></span><br><span class="line">      <span class="keyword">if</span> (pkg.childPackages != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">              ... ...</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">... ...</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// either use what we&#x27;ve been given or parse directly from the APK</span></span><br><span class="line">          <span class="comment">// 权限信息的一些处理</span></span><br><span class="line">          <span class="keyword">if</span> (args.certificates != <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  <span class="comment">// 如果args中包含了权限信息，则直接用参数中的权限配置package</span></span><br><span class="line">                  PackageParser.populateCertificates(pkg, args.certificates);</span><br><span class="line">              &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">                  <span class="comment">// there was something wrong with the certificates we were given;</span></span><br><span class="line">                  <span class="comment">// try to pull them from the APK</span></span><br><span class="line">                  PackageParser.collectCertificates(pkg, parseFlags);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// 否则直接从Manifest.xml中解析出权限信息</span></span><br><span class="line">              PackageParser.collectCertificates(pkg, parseFlags);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">          res.setError(<span class="string">&quot;Failed collect during installPackageLI&quot;</span>, e);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Get rid of all references to package scan path via parser.</span></span><br><span class="line">      pp = <span class="literal">null</span>;</span><br><span class="line">      <span class="type">String</span> <span class="variable">oldCodePath</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="type">boolean</span> <span class="variable">systemApp</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Check if installing already existing package</span></span><br><span class="line">      <span class="comment">// 检查安装的package是否已经存在，即是否重复安装，会根据运行时权限、签名信息、</span></span><br><span class="line">      <span class="comment">// 版本、是否系统APP等条件，判断能否继续安装</span></span><br><span class="line">... ...</span><br><span class="line"><span class="comment">// 重命名copy时临时赋予的名字</span></span><br><span class="line">      <span class="keyword">if</span> (!args.doRename(res.returnCode, pkg, oldCodePath)) &#123;</span><br><span class="line">          res.setError(INSTALL_FAILED_INSUFFICIENT_STORAGE, <span class="string">&quot;Failed rename&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      startIntentFilterVerifications(args.user.getIdentifier(), replace, pkg);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> (<span class="type">PackageFreezer</span> <span class="variable">freezer</span> <span class="operator">=</span> freezePackageForInstall(pkgName, installFlags,</span><br><span class="line">              <span class="string">&quot;installPackageLI&quot;</span>)) &#123;</span><br><span class="line">          <span class="keyword">if</span> (replace) &#123;</span><br><span class="line">              <span class="comment">// 用新的package信息替换旧的</span></span><br><span class="line">              replacePackageLIF(pkg, parseFlags, scanFlags | SCAN_REPLACING, args.user,</span><br><span class="line">                      installerPackageName, res);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// 把新的package信息加入到PKMS中</span></span><br><span class="line">              installNewPackageLIF(pkg, parseFlags, scanFlags | SCAN_DELETE_DATA_ON_FAILURES,</span><br><span class="line">                      args.user, installerPackageName, volumeUuid, res);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">          <span class="keyword">final</span> <span class="type">PackageSetting</span> <span class="variable">ps</span> <span class="operator">=</span> mSettings.mPackages.get(pkgName);</span><br><span class="line">          <span class="keyword">if</span> (ps != <span class="literal">null</span>) &#123;</span><br><span class="line">              res.newUsers = ps.queryInstalledUsers(sUserManager.getUserIds(), <span class="literal">true</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">final</span> <span class="type">int</span> <span class="variable">childCount</span> <span class="operator">=</span> (pkg.childPackages != <span class="literal">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">              PackageParser.<span class="type">Package</span> <span class="variable">childPkg</span> <span class="operator">=</span> pkg.childPackages.get(i);</span><br><span class="line">              <span class="type">PackageInstalledInfo</span> <span class="variable">childRes</span> <span class="operator">=</span> res.addedChildPackages.get(childPkg.packageName);</span><br><span class="line">              <span class="type">PackageSetting</span> <span class="variable">childPs</span> <span class="operator">=</span> mSettings.peekPackageLPr(childPkg.packageName);</span><br><span class="line">              <span class="keyword">if</span> (childPs != <span class="literal">null</span>) &#123;</span><br><span class="line">                  childRes.newUsers = childPs.queryInstalledUsers(</span><br><span class="line">                          sUserManager.getUserIds(), <span class="literal">true</span>);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>这部分代码太长了，也没有细看，installPackageTracedLI的主要工作就是解析APK文件，形成对应的Package对象；生成对应的权限信息后，根据Package中的信息，更改存储路径对应目录的名称。</p>
<h4 id="6-3-doPostInstall"><a href="#6-3-doPostInstall" class="headerlink" title="6.3 doPostInstall"></a>6.3 doPostInstall</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FileInstallArgs</span> <span class="keyword">extends</span> <span class="title class_">InstallArgs</span> &#123;</span><br><span class="line">  ... ...</span><br><span class="line">    <span class="type">int</span> <span class="title function_">doPostInstall</span><span class="params">(<span class="type">int</span> status, <span class="type">int</span> uid)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (status != PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">            cleanUp();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>doPostInstall和doPreInstall一样，没做什么实质性的操作。</p>
<h4 id="6-4-POST-INSTALL消息处理"><a href="#6-4-POST-INSTALL消息处理" class="headerlink" title="6.4 POST_INSTALL消息处理"></a>6.4 POST_INSTALL消息处理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PackageHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line">  ... ...</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">doHandleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> POST_INSTALL: &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_INSTALL) Log.v(TAG, <span class="string">&quot;Handling post-install for &quot;</span> + msg.arg1);</span><br><span class="line"></span><br><span class="line">                <span class="type">PostInstallData</span> <span class="variable">data</span> <span class="operator">=</span> mRunningInstalls.get(msg.arg1);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">didRestore</span> <span class="operator">=</span> (msg.arg2 != <span class="number">0</span>);</span><br><span class="line">                mRunningInstalls.delete(msg.arg1);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (data != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">InstallArgs</span> <span class="variable">args</span> <span class="operator">=</span> data.args;</span><br><span class="line">                    <span class="type">PackageInstalledInfo</span> <span class="variable">parentRes</span> <span class="operator">=</span> data.res;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">grantPermissions</span> <span class="operator">=</span> (args.installFlags</span><br><span class="line">                            &amp; PackageManager.INSTALL_GRANT_RUNTIME_PERMISSIONS) != <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">killApp</span> <span class="operator">=</span> (args.installFlags</span><br><span class="line">                            &amp; PackageManager.INSTALL_DONT_KILL_APP) == <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">final</span> String[] grantedPermissions = args.installGrantPermissions;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Handle the parent package</span></span><br><span class="line">                    <span class="comment">// 处理父package</span></span><br><span class="line">                    handlePackagePostInstall(parentRes, grantPermissions, killApp,</span><br><span class="line">                            grantedPermissions, didRestore, args.installerPackageName,</span><br><span class="line">                            args.observer);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Handle the child packages</span></span><br><span class="line">                    <span class="comment">// 处理子package</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">childCount</span> <span class="operator">=</span> (parentRes.addedChildPackages != <span class="literal">null</span>)</span><br><span class="line">                            ? parentRes.addedChildPackages.size() : <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">                        <span class="type">PackageInstalledInfo</span> <span class="variable">childRes</span> <span class="operator">=</span> parentRes.addedChildPackages.valueAt(i);</span><br><span class="line">                        handlePackagePostInstall(childRes, grantPermissions, killApp,</span><br><span class="line">                                grantedPermissions, <span class="literal">false</span>, args.installerPackageName,</span><br><span class="line">                                args.observer);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Log tracing if needed</span></span><br><span class="line">                    <span class="keyword">if</span> (args.traceMethod != <span class="literal">null</span>) &#123;</span><br><span class="line">                        Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, args.traceMethod,</span><br><span class="line">                                args.traceCookie);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.e(TAG, <span class="string">&quot;Bogus post-install token &quot;</span> + msg.arg1);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;postInstall&quot;</span>, msg.arg1);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            ... ...</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlePackagePostInstall</span><span class="params">(PackageInstalledInfo res, <span class="type">boolean</span> grantPermissions,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> killApp, String[] grantedPermissions,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> launchedForRestore, String installerPackage,</span></span><br><span class="line"><span class="params">        IPackageInstallObserver2 installObserver)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">        <span class="comment">// Send the removed broadcasts</span></span><br><span class="line">        <span class="comment">// 赋予package权限，发送ACTION_PACKAGE_ADDED等广播</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If someone is watching installs - notify them</span></span><br><span class="line">    <span class="comment">// 如果有观察者监控安装信息，就通知它</span></span><br><span class="line">    <span class="keyword">if</span> (installObserver != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bundle</span> <span class="variable">extras</span> <span class="operator">=</span> extrasForInstallResult(res);</span><br><span class="line">            installObserver.onPackageInstalled(res.name, res.returnCode,</span><br><span class="line">                    res.returnMsg, extras);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">&quot;Observer no longer exists.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从代码看出处理POST_INSTALL消息的主要工作是通过广播和回调接口通知系统中的其他组件package的安装和改变信息。</p>
<p>点击查看 <a target="_blank" rel="noopener" href="http://otqux1hnn.bkt.clouddn.com/rangerzhou/170928/handleReturnCode.png">handleReturnCode流程图</a> 。</p>
<p><img src="http://otqux1hnn.bkt.clouddn.com/rangerzhou/170928/handleReturnCode.png" alt="handleReturnCode"></p>
<h3 id="7-总结"><a href="#7-总结" class="headerlink" title="7. 总结"></a>7. 总结</h3><p>点击查看 <a target="_blank" rel="noopener" href="http://otqux1hnn.bkt.clouddn.com/rangerzhou/170929/apkinstall.png">APK安装整体流程图</a> 。</p>

    </div>

    
    
    
        <div class="reward-container">
  <div>Donate comment here.</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.jpg" alt="Ranger Zhou 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.jpg" alt="Ranger Zhou 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Ranger Zhou
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://rangerzhou.top/2017/06/26/Android/Android_7.0_PackageManagerService_sourceCode_study/" title="Android 7.0 PackageManagerService源码分析">http://rangerzhou.top/2017/06/26/Android/Android_7.0_PackageManagerService_sourceCode_study/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2017/06/14/Others/Markdown_grammar/" rel="prev" title="Markdown语法手册">
      <i class="fa fa-chevron-left"></i> Markdown语法手册
    </a></div>
      <div class="post-nav-item">
    <a href="/2017/06/30/Android/Something_about_Dalvik_ART_DEX_ODEX_JIT_AOT_OAT/" rel="next" title="关于 Dalvik、ART、DEX、ODEX、JIT、AOT、OAT">
      关于 Dalvik、ART、DEX、ODEX、JIT、AOT、OAT <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-disqus">disqus</a></li>
            <li class="tab"><a href="#comment-gitalk">gitalk</a></li>
            <li class="tab"><a href="#comment-livere">livere</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane disqus" id="comment-disqus">
              
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  
            </div>
            <div class="tab-pane gitalk" id="comment-gitalk">
              <div class="comments" id="gitalk-container"></div>
            </div>
            <div class="tab-pane livere" id="comment-livere">
              
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC8yOTcyNS82Mjky"></div>
  </div>
  
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-adb-install-%E5%88%86%E6%9E%90"><span class="nav-text">1. adb install 分析#</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-install-app"><span class="nav-text">1.1 install_app</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-install-app-legacy"><span class="nav-text">1.2 install_app_legacy</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-pm-command"><span class="nav-text">2. pm_command</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Pm-java%E6%B5%81%E7%A8%8B"><span class="nav-text">3. Pm.java流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-Create-Session"><span class="nav-text">3.1 Create Session</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-Write-Session"><span class="nav-text">3.2 Write Session</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-1-%E5%BE%97%E5%88%B0PackageInstallerSession%E7%9A%84%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1"><span class="nav-text">3.2.1 得到PackageInstallerSession的代理对象</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-2-%E5%AE%9A%E4%B9%89%E8%BE%93%E5%87%BA%E7%AB%AF%EF%BC%8C%E5%BE%97%E5%88%B0%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">3.2.2 定义输出端，得到客户端</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-Commit-Session"><span class="nav-text">3.3 Commit Session</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-installStage"><span class="nav-text">4. installStage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-handleStartCopy"><span class="nav-text">5. handleStartCopy</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-getMinimalPackageInfo"><span class="nav-text">5.1 getMinimalPackageInfo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-installLocationPolicy"><span class="nav-text">5.2 installLocationPolicy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-createInstallArgs"><span class="nav-text">5.3 createInstallArgs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-copyApk"><span class="nav-text">5.4 copyApk</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-handleReturnCode"><span class="nav-text">6. handleReturnCode</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-doPreInstall"><span class="nav-text">6.1 doPreInstall</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-installPackageTracedLI"><span class="nav-text">6.2 installPackageTracedLI</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-doPostInstall"><span class="nav-text">6.3 doPostInstall</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-POST-INSTALL%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86"><span class="nav-text">6.4 POST_INSTALL消息处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E6%80%BB%E7%BB%93"><span class="nav-text">7. 总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Ranger Zhou</p>
  <div class="site-description" itemprop="description">我是一个小流氓我从来也不浪，有一天我心血来潮耍了个流氓，我嘴里吹着小口哨我心里好得意，不知怎么哗啦啦啦啦我摔了一身泥</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">69</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/rangerzhou" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;rangerzhou" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:rangero_o@qq.com" title="E-Mail → mailto:rangero_o@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://rangerzhou.taobao.com/" title="Taobao → http:&#x2F;&#x2F;rangerzhou.taobao.com&#x2F;" rel="noopener" target="_blank"><i class="fab fa-youtube fa-fw"></i>Taobao</a>
      </span>
      <span class="links-of-author-item">
        <a href="/images/wechat.jpg" title="WeChat → &#x2F;images&#x2F;wechat.jpg"><i class="fab fa-youtube fa-fw"></i>WeChat</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://blog.csdn.net/ranger0220?viewmode=contents" title="CSDN → http:&#x2F;&#x2F;blog.csdn.net&#x2F;ranger0220?viewmode&#x3D;contents" rel="noopener" target="_blank"><i class="fab fa-youtube fa-fw"></i>CSDN</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      墙裂推荐
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://rangerzhou.taobao.com/" title="http:&#x2F;&#x2F;rangerzhou.taobao.com" rel="noopener" target="_blank">Taobao</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ranger Zhou</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        






<script data-pjax>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"U9g4mWmsQg8FjOE3xsqUy9Df-gzGzoHsz","app_key":"24cDno14OiDhAreVmoEjzqns","server_url":"https://u9g4mwms.lc-cn-n1-shared.com","security":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  
  <script data-pjax>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  

<script>
  var disqus_config = function() {
    this.page.url = "http://rangerzhou.top/2017/06/26/Android/Android_7.0_PackageManagerService_sourceCode_study/";
    this.page.identifier = "2017/06/26/Android/Android_7.0_PackageManagerService_sourceCode_study/";
    this.page.title = "Android 7.0 PackageManagerService源码分析";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://rangerzhou.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'b7bb504993135f5a2eab',
      clientSecret: '6f83aec5c45d75e248e2914be90c4601e2e1dc44',
      repo        : 'rangerzhou.github.io',
      owner       : 'rangerzhou',
      admin       : ['rangerzhou'],
      id          : '04e387d21692bcf05ddb0aa90507e6dc',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>

    </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/haru01.model.json"},"display":{"position":"left","width":300,"height":800},"mobile":{"show":false},"log":false});</script></body>
</html>
