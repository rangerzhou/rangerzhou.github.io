---
title: 关于Dalvik、ART、DEX、ODEX、JIT、AOT、OAT
date: 2017-06-30 16:29:38
tags:
categories: Android
copyright: true
---

关于Dalvik、ART、DEX、ODEX、JIT、AOT、OAT，说真的，我看着都头大，每次看完过不了多久就会忘记一些内容，然后再去搜资料，好记性不如烂笔头，写在这里随时温故。

<!--more-->

# 1. Dalvik和ART

## 1.1 Dalvik

Dalvik是Google公司自己设计用于Android平台的虚拟机。DVM即Dalvik Virtual Machine的缩写，那么DVM和JVM有什么区别呢？

1. DVM基于寄存器，JVM基于栈

   寄存器是CPU上面的一块存储空间，栈是内存上面的一段连续的存储空间，所以CPU直接访问自己上面的一块空间的数据的效率肯定要大于访问内存上面的数据。基于栈架构的程序在运行时虚拟机需要频繁的从栈上读取或写入数据，这个过程需要更多的指令分派与内存访问次数，会耗费不少CPU时间，对于像手机设备资源有限的设备来说，这是相当大的一笔开销。DVM基于寄存器架构。数据的访问通过寄存器间直接传递，这样的访问方式比基于栈方式要快很多。

2. 执行的字节码文件不一样

   DVM执行的是.dex文件，JVM执行的是.class文件。

   AVM

   .java --> .class --> .dex --> .apk，

   JVM

   .java --> .class --> .jar

3. 运行环境的区别

   DVM：允许运行多个虚拟机实例，每一个应用启动都运行一个单独的虚拟机，并且运行在一个独立的进程中

   JVM：只能运行一个实例，也就是所有应用都运行在同一个JVM中

## 1.2 ART

ART即Android Runtime，是在Dalvik的基础上做了一些优化。在Dalvik下，应用每次运行的时候，字节码都需要通过即时编译器（just in time ，JIT）转换为机器码，这会拖慢应用的运行效率，而在ART 环境中，应用在第一次安装的时候，字节码就会预先编译成机器码，使其成为真正的本地应用。这个过程叫做预编译（AOT,Ahead-Of-Time）。这样的话，应用的启动(首次)和执行都会变得更加快速。

## 1.3 Dalvik和ART区别

Dalvik是执行的时候编译+运行，安装比较快，开启应用比较慢，应用占用空间小；ART是安装的时候就编译好了，执行的时候直接就可以运行的，安装慢，开启应用快，占用空间大；

比较喜欢一个骑自行车的例子，Dalvik好比一个已经折叠起来的自行车，每次骑之前都要先撑开才能骑，ART相当于一个已经撑开的自行车，每次直接骑着就走了。

# 2. dex、odex、oat

## 2.1 dex

dex(Dalvik Executable)，本质上java文件变异后都是字节码，只不过JVM运行的是.class字节码，而DVM运行的是.dex字节码，sdk\build-tools\25.0.2\dx工具负责将Java字节码.class文件转换为Dalvik字节码.dex，dx工具对Java类文件重新排列，消除在类文件中出现的所有冗余信息，避免虚拟机在初始化时出现反复的文件加载与解析过程。一般情况下，Java类文件中包含多个不同的方法签名，如果其他的类文件引用该类文件中的方法，方法签名也会被复制到其类文件中，也就是说，多个不同的类会同时包含相同的方法签名，同样地，大量的字符串常量在多个类文件中也被重复使用。这些冗余信息会直接增加文件的体积，同时也会严重影响虚拟机解析文件的效率。消除其中的冗余信息，重新组合形成一个常量池，所有的类文件共享同一个常量池。由于dx工具对常量池的压缩，使得相同的字符串，常量在DEX文件中只出现一次，从而减小了文件的体积。

## 2.2 odex

odex(Optimized dex)，即优化的dex，主要是为了提高DVM的运行速度，